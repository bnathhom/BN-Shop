<!-- Firebase CDN Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<script>
  // Firebase config ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì
  const firebaseConfig = {
    apiKey: "AIzaSyAR4ZN_J3u4nTl2dLpF6eXqE3txaUoYrMY",
    authDomain: "bnchen-93d9d.firebaseapp.com",
    projectId: "bnchen-93d9d",
    storageBucket: "bnchen-93d9d.firebasestorage.app",
    messagingSenderId: "1047651812089",
    appId: "1:1047651812089:web:6f520fa528059cc43e1828",
    measurementId: "G-WK259X0ZQ1"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
</script>

<!-- ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö -->
<div class="order-form" id="auth-section">
  <h2>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö / ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
  <div class="form-control">
    <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
    <input type="email" id="email" placeholder="example@email.com">
  </div>
  <div class="form-control">
    <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
    <input type="password" id="password" placeholder="‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£">
  </div>
  <button class="btn" onclick="signIn()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
  <button class="btn" onclick="signUp()">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
</div>

<div id="user-info" class="order-form" style="display: none;">
  <p>üë§ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏î‡∏¢: <span id="user-email"></span></p >
  <button class="btn btn-danger" onclick="signOut()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
</div>

<script>
  function signUp() {
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value.trim();
    if (!email || !password) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

    auth.createUserWithEmailAndPassword(email, password)
      .then(userCredential => {
        alert("‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      })
      .catch(error => {
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
      });
  }

  function signIn() {
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value.trim();
    if (!email || !password) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

    auth.signInWithEmailAndPassword(email, password)
      .then(userCredential => {
        alert("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      })
      .catch(error => {
        alert("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
      });
  }

  function signOut() {
    auth.signOut().then(() => {
      alert("‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
    });
  }

  auth.onAuthStateChanged(user => {
    if (user) {
      document.getElementById("auth-section").style.display = "none";
      document.getElementById("user-info").style.display = "block";
      document.getElementById("user-email").innerText = user.email;

      // ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ
      document.querySelectorAll('.order-form, .order-list').forEach(el => el.style.display = "block");
    } else {
      document.getElementById("auth-section").style.display = "block";
      document.getElementById("user-info").style.display = "none";

      // ‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô
      document.querySelectorAll('.order-form, .order-list').forEach(el => {
        if (!el.id.includes('auth') && !el.id.includes('user-info')) {
          el.style.display = "none";
        }
      });
    }
  });
</script>
<!DOCTYPE html>
<html lang="lo">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BN Shop Order System</title>
  <style>
    body { font-family: 'Noto Sans Lao', sans-serif; padding: 20px; }
    h1 { text-align: center; }
    .order-form, .order-list { margin: 20px auto; max-width: 500px; border: 1px solid #ccc; padding: 20px; border-radius: 8px; }
    .form-control { margin-bottom: 10px; }
    .form-control label { display: block; margin-bottom: 5px; }
    .form-control input, .form-control textarea, .form-control select { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
    .btn { padding: 10px 20px; border: none; border-radius: 5px; background-color: #007BFF; color: white; cursor: pointer; }
    .btn-danger { background-color: #dc3545; }
    .order { border: 1px dashed #aaa; padding: 10px; margin: 10px 0; position: relative; }
    .order input[type=checkbox] { position: absolute; right: 10px; top: 10px; }
    .print-btns { margin-top: 20px; text-align: center; }
    .bill { width: 76mm; height: auto; min-height: 130mm; padding: 10px; font-size: 14px; box-sizing: border-box; border: 1px solid #000; margin: 0 auto; overflow: hidden; }
    .logo { font-size: 48px; font-weight: bold; display: inline-block; vertical-align: middle; margin-right: 10px; }
    .shop-info { display: inline-block; vertical-align: middle; line-height: 1.4; white-space: nowrap; }
    .header { margin-bottom: 10px; }
    .section { margin-top: 10px; }
    .barcode-container { text-align: center; margin: 15px 0; }
    .barcode-number { text-align: center; font-family: monospace; font-size: 12px; margin-top: 5px; }
    .thankyou { text-align: center; margin-top: 20px; font-weight: bold; }
    .customer-pre, .bill pre { 
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: 'Noto Sans Lao', sans-serif;
      margin: 0;
      line-height: 1.4;
    }
  </style>
</head>
<body>
  <h1>BN Shop Order System</h1>
  <div class="order-form">
    <div class="form-control">
      <label>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
      <textarea id="customerData" rows="4"></textarea>
    </div>
    <div class="form-control">
      <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏ô‡∏™‡πà‡∏á</label>
      <select id="courier">
        <option value="HAL LOGISTICS">HAL LOGISTICS</option>
        <option value="Anousith Express">Anousith Express</option>
        <option value="Mixay Express">Mixay Express</option>
      </select>
    </div>
    <div class="form-control">
      <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏£‡πâ‡∏≤‡∏ô (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏Ç‡∏ô‡∏™‡πà‡∏á)</label>
      <select id="shopPhone" disabled>
        <option value="020 94036226">020 94036226</option>
        <option value="020 98052744">020 98052744</option>
      </select>
    </div>
    <button class="btn" onclick="addOrder()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
  </div>

  <div class="order-list">
    <h2>‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
    <div id="orders"></div>
    <div class="print-btns">
      <button class="btn" onclick="printSelected()">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
      <button class="btn" onclick="printAll()">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script>
    let orderList = [];

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Local Storage ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î
    window.onload = () => {
      const savedOrders = localStorage.getItem('bnShopOrders');
      if (savedOrders) {
        orderList = JSON.parse(savedOrders);
        orderList.forEach(order => {
          order.date = new Date(order.date);
        });
        renderOrders();
      }
      
      // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡∏≤‡∏°‡∏Ç‡∏ô‡∏™‡πà‡∏á
      updatePhoneByCourier();
    };

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡∏≤‡∏°‡∏Ç‡∏ô‡∏™‡πà‡∏á
    function updatePhoneByCourier() {
      const courier = document.getElementById('courier').value;
      const phoneSelect = document.getElementById('shopPhone');
      
      if (courier === 'Anousith Express') {
        phoneSelect.value = '020 94036226';
      } else {
        phoneSelect.value = '020 98052744';
      }
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏ô‡∏™‡πà‡∏á
    document.getElementById('courier').addEventListener('change', updatePhoneByCourier);

    function saveToLocalStorage() {
      localStorage.setItem('bnShopOrders', JSON.stringify(orderList));
    }

    function generateId() {
      return 'BN' + Math.floor(Math.random() * 100000);
    }

    function addOrder() {
      const customer = document.getElementById('customerData').value.trim();
      const courier = document.getElementById('courier').value;
      const shopPhone = document.getElementById('shopPhone').value;
      
      if (!customer) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤');

      const id = generateId();
      const date = new Date();
      const barcode = Math.floor(100000000000 + Math.random() * 900000000000);
      const order = { id, customer, courier, date, barcode, shopPhone };
      orderList.push(order);
      saveToLocalStorage();
      document.getElementById('customerData').value = '';
      renderOrders();
    }

    function renderOrders() {
      const container = document.getElementById('orders');
      container.innerHTML = '';
      orderList.forEach((order, index) => {
        const div = document.createElement('div');
        div.className = 'order';
        div.innerHTML = `
          <input type="checkbox" data-index="${index}" checked>
          <strong>Order ID:</strong> ${order.id}<br>
          <strong>‡∏Ç‡∏ô‡∏™‡πà‡∏á:</strong> ${order.courier}<br>
          <strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡πâ‡∏≤‡∏ô:</strong> ${order.shopPhone}<br>
          <strong>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</strong><br> <pre class="customer-pre">${order.customer}</pre>
          <button class="btn btn-danger" onclick="deleteOrder(${index})">‡∏•‡∏ö</button>
          <button class="btn" onclick="editOrder(${index})">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        `;
        container.appendChild(div);
      });
    }

    function deleteOrder(index) {
      if (confirm('‡∏•‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?')) {
        orderList.splice(index, 1);
        saveToLocalStorage();
        renderOrders();
      }
    }

    function editOrder(index) {
      const order = orderList[index];
      const updated = prompt('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:', order.customer);
      if (updated !== null) {
        order.customer = updated.trim();
        saveToLocalStorage();
        renderOrders();
      }
    }

    function generateBarcodeSVG(barcodeNumber) {
      const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      JsBarcode(svg, barcodeNumber.toString(), {
        format: "CODE128",
        lineColor: "#000",
        width: 2,
        height: 50,
        displayValue: false
      });
      return svg.outerHTML;
    }

    function printBill(order) {
      const dateStr = order.date.toLocaleString();
      const barcodeSVG = generateBarcodeSVG(order.barcode);
      
      return `
        <div class="bill">
          <div class="header">
            <div class="logo">BN</div>
            <div class="shop-info">
              ‡∫Æ‡ªâ‡∫≤‡∫ô : BN Shop<br>
              ‡ªÄ‡∫ö‡∫µ‡ªÇ‡∫ó : ${order.shopPhone}
            </div>
          </div>
          <div class="section">
            <div><strong>‡∫ß‡∫±‡∫ô‡∫ó‡∫µ:</strong> ${dateStr}</div>
            <div><strong>‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫≠‡∫≠‡ªÄ‡∫î‡∫µ:</strong> ${order.id}</div>
          </div>
          <div class="barcode-container">
            ${barcodeSVG}
            <div class="barcode-number">${order.barcode}</div>
          </div>
          <div class="section">
            <div><strong>‡∫Ç‡∫ª‡∫ô‡∫™‡∫ª‡ªà‡∫á:</strong> ${order.courier}</div>
            <div><strong>‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤:</strong><br><pre>${order.customer.replace(/\n/g, '<br>')}</pre></div>
          </div>
          <div class="thankyou">‡∫Ç‡ªç‡∫Ç‡∫≠‡∫ö‡ªÉ‡∫àüíó</div>
        </div>
      `;
    }

    function printSelected() {
      const checkboxes = document.querySelectorAll('#orders input[type=checkbox]');
      const selectedOrders = Array.from(checkboxes)
                               .filter(c => c.checked)
                               .map(c => orderList[c.dataset.index]);
      
      if (selectedOrders.length === 0) {
        return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå');
      }
      
      printBills(selectedOrders);
    }

    function printAll() {
      if (orderList.length === 0) {
        return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå');
      }
      
      printBills(orderList);
    }

    function printBills(orders) {
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html>
          <head>
            <title>Print Bills</title>
            <style>
              body { margin: 0; padding: 0; }
              @page { size: 80mm 150mm; margin: 0; }
              .bill { 
                width: 76mm; 
                height: auto; 
                min-height: 130mm; 
                padding: 10px; 
                font-size: 14px; 
                box-sizing: border-box; 
                border: 1px solid #000; 
                margin: 0 auto 10mm; 
                page-break-after: always; 
                font-family: 'Noto Sans Lao', sans-serif; 
                overflow: hidden;
              }
              .logo { font-size: 48px; font-weight: bold; display: inline-block; vertical-align: middle; margin-right: 10px; }
              .shop-info { display: inline-block; vertical-align: middle; line-height: 1.4; white-space: nowrap; }
              .header { margin-bottom: 10px; }
              .section { margin-top: 10px; }
              .barcode-container { text-align: center; margin: 15px 0; }
              .barcode-number { text-align: center; font-family: monospace; font-size: 12px; margin-top: 5px; }
              .thankyou { text-align: center; margin-top: 20px; font-weight: bold; }
              pre {
                white-space: pre-wrap;
                word-wrap: break-word;
                margin: 0;
                line-height: 1.4;
              }
            </style>
          </head>
          <body>
      `);
      
      orders.forEach(order => {
        printWindow.document.write(printBill(order));
      });
      
      printWindow.document.write(`
          </body>
        </html>
      `);
      
      printWindow.document.close();
      setTimeout(() => {
        printWindow.print();
      }, 500);
    }
  </script>
</body>
</html>