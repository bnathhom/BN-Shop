<!DOCTYPE html>
<html lang="lo">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>BN Shop Order System</title>
  <style>
    body{font-family:'Noto Sans Lao',sans-serif;padding:20px;}
    .hidden{display:none;}
    .topbar{display:flex;justify-content:flex-end;margin-bottom:10px;}
    .btn{padding:8px 16px;margin:2px;border:none;border-radius:4px;color:white;background:#007BFF;cursor:pointer;}
    .btn-danger{background:#dc3545;}
    .order{border:1px dashed #aaa;padding:10px;margin:5px;position:relative;}
    .order input[type=checkbox]{position:absolute;right:10px;top:10px;}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
</head>
<body>

<!-- LOGIN & SIGNUP -->
<div id="auth-view">
  <h2>เข้าสู่ระบบ / สมัคร</h2>
  <input type="email" id="email" placeholder="Email"><br><br>
  <input type="password" id="password" placeholder="Password"><br><br>
  <button class="btn" onclick="signup()">สมัคร</button>
  <button class="btn" onclick="login()">ล็อกอิน</button>
  <p id="auth-error" style="color:red;"></p>
</div>

<!-- MAIN DASHBOARD -->
<div id="app-view" class="hidden">
  <div class="topbar">
    <button class="btn" onclick="showWarehouse()">คลัง</button>
    <button class="btn btn-danger" onclick="logout()">Logout</button>
  </div>

  <!-- สร้างออเดอร์ -->
  <h2>เพิ่มออเดอร์</h2>
  <textarea id="customerData" rows="3" placeholder="ข้อมูลลูกค้า"></textarea><br>
  <select id="courier"><option>HAL LOGISTICS</option><option>Anousith Express</option><option>Mixay Express</option></select>
  <select id="shopPhone" disabled><option>020 94036226</option><option>020 98052744</option></select>
  <button class="btn" onclick="addOrder()">ยืนยันออเดอร์</button>

  <!-- รายการออเดอร์หลัก -->
  <h2>ออเดอร์ทั้งหมด</h2>
  <button class="btn" onclick="selectAll(true)">เลือกทั้งหมด</button>
  <button class="btn" onclick="selectAll(false)">ยกเลิกทั้งหมด</button><br>
  <div id="orders"></div>
  <button class="btn" onclick="printSelected()">พิมพ์ที่เลือก</button>
  <button class="btn" onclick="printAll()">พิมพ์ทั้งหมด</button>
  <button class="btn btn-danger" onclick="deleteSelected()">ลบที่เลือก</button>
  <button class="btn" onclick="archiveSelected()">เก็บเข้าคลัง</button>
</div>

<!-- คลัง -->
<div id="warehouse-view" class="hidden">
  <div class="topbar">
    <button class="btn" onclick="showApp()">กลับ</button>
    <button class="btn btn-danger" onclick="logout()">Logout</button>
  </div>
  <h2>ออเดอร์ในคลัง</h2>
  <div id="warehouse"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAR4ZN_J3u4nTl2dLpF6eXqE3txaUoYrMY",
  authDomain: "bnchen-93d9d.firebaseapp.com",
  projectId: "bnchen-93d9d"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app), auth = getAuth();

let orderList = [], warehouseList = [];

function signup(){
  const e=document.getElementById('email').value, p=document.getElementById('password').value;
  createUserWithEmailAndPassword(auth,e,p).catch(e=>document.getElementById('auth-error').innerText=e.message);
}
function login(){
  const e=document.getElementById('email').value, p=document.getElementById('password').value;
  signInWithEmailAndPassword(auth,e,p).catch(e=>document.getElementById('auth-error').innerText=e.message);
}
function logout(){ signOut(auth); }

onAuthStateChanged(auth,user=>{
  document.getElementById('auth-view').classList.toggle('hidden',!!user);
  document.getElementById('app-view').classList.toggle('hidden',!user);
  document.getElementById('warehouse-view').classList.add('hidden');
  if(user){ loadOrders(); loadWarehouse(); }
});

document.getElementById('courier').addEventListener('change',()=>{
  document.getElementById('shopPhone').value =
    document.getElementById('courier').value==='Anousith Express' ? '020 94036226' : '020 98052744';
});

async function loadOrders(){
  const qs = await getDocs(collection(db,'orders'));
  orderList = [];
  qs.forEach(s=> orderList.push({...s.data(), idDoc:s.id}));
  renderOrders();
}
async function loadWarehouse(){
  const q = query(collection(db,'orders'),where('archived','==',true));
  const qs = await getDocs(q);
  warehouseList = [];
  qs.forEach(s=> warehouseList.push({...s.data(), idDoc:s.id}));
  renderWarehouse();
}

function renderOrders(){
  const c = document.getElementById('orders'); c.innerHTML='';
  orderList.filter(o=>!o.archived).forEach((o,i)=>{
    const d=document.createElement('div'); d.className='order';
    d.innerHTML=`
    <input type="checkbox" data-index="${i}" checked>
    <b>ID:</b> ${o.id} <b>${o.courier}</b><br>
    <pre>${o.customer}</pre>
    <button class="btn" onclick="editOrder(${i})">แก้ไข</button>
    `;
    c.appendChild(d);
  });
}
function renderWarehouse(){
  const c=document.getElementById('warehouse'); c.innerHTML='';
  warehouseList.forEach((o,i)=>{
    const d=document.createElement('div'); d.className='order';
    d.innerHTML=`
    <b>ID:</b> ${o.id} (คลัง)<br><pre>${o.customer}</pre>
    <button class="btn" onclick="restoreOrder(${i})">คืน</button>
    <button class="btn btn-danger" onclick="delOrder(${i},true)">ลบถาวร</button>
    `;
    c.appendChild(d);
  });
}
function selectAll(b){
  document.querySelectorAll('#orders input[type=checkbox]').forEach(c=>c.checked=b);
}

async function addOrder(){
  const cust=document.getElementById('customerData').value.trim(), cour=document.getElementById('courier').value, phone=document.getElementById('shopPhone').value;
  if(!cust) return alert('กรอกลูกค้า');
  await addDoc(collection(db,'orders'),{id:'BN'+Date.now(),customer:cust,courier:cour,shopPhone:phone,date:Date.now(),barcode:String(Date.now()),archived:false});
  document.getElementById('customerData').value='';
  loadOrders();
}
function editOrder(i){
  const o=orderList[i];
  const cust=prompt('แก้ไขลูกค้า',o.customer);
  if(cust!==null){
    updateDoc(doc(db,'orders',o.idDoc),{customer:cust}).then(loadOrders);
  }
}
async function deleteSelected(){
  const ch=document.querySelectorAll('#orders input[type=checkbox]');
  for(const c of ch) if(c.checked){
    const o=orderList[c.dataset.index];
    await deleteDoc(doc(db,'orders',o.idDoc));
  }
  loadOrders(); loadWarehouse();
}
async function archiveSelected(){
  const ch=document.querySelectorAll('#orders input[type=checkbox]');
  for(const c of ch) if(c.checked){
    const o=orderList[c.dataset.index];
    await updateDoc(doc(db,'orders',o.idDoc),{archived:true});
  }
  loadOrders(); loadWarehouse();
}
async function restoreOrder(i){
  const o=warehouseList[i];
  await updateDoc(doc(db,'orders',o.idDoc),{archived:false});
  loadOrders(); loadWarehouse();
}
async function delOrder(i,isWare){
  const o = isWare ? warehouseList[i] : orderList[i];
  await deleteDoc(doc(db,'orders',o.idDoc));
  loadOrders(); loadWarehouse();
}

function printSelected(){ printBills(orderList.filter((_,i)=>document.querySelectorAll('#orders input')[i].checked)); }
function printAll(){ printBills(orderList); }

function printBills(arr){
  if(!arr.length) return alert('ไม่มีออเดอร์');
  const w = window.open(); w.document.write('<html><body>');
  arr.forEach(o=>{
    const svg=document.createElementNS("http://www.w3.org/2000/svg","svg");
    JsBarcode(svg,o.barcode,{format:"CODE128",width:2,height:50,displayValue:false});
    w.document.write(`<div style="page-break-after:always;"><b>ID:</b>${o.id}<br>${svg.outerHTML}<br><pre>${o.customer}</pre></div>`);
  });
  w.document.write('</body></html>'); w.document.close(); setTimeout(()=>w.print(),500);
}

function showWarehouse(){document.getElementById('app-view').classList.add('hidden');document.getElementById('warehouse-view').classList.remove('hidden');}
function showApp(){document.getElementById('warehouse-view').classList.add('hidden');document.getElementById('app-view').classList.remove('hidden');}
</script>
</body>
</html>
