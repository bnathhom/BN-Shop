<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HSK 4 Masterclass - Global Edition</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Sans+Thai:wght@300;400;600;800&family=Noto+Sans+Lao:wght@300;400;600&family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <!-- Confetti Library for Celebration -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- Config & Styles -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'china-red': '#E60012',
                        'china-gold': '#FFD700',
                        'jade-dark': '#005f4b',
                        'jade-light': '#00a884',
                        'paper': '#f8f4e6',
                        'ink': '#2c2c2c'
                    },
                    fontFamily: {
                        'thai': ['"Noto Sans Thai"', 'sans-serif'],
                        'lao': ['"Noto Sans Lao"', 'sans-serif'],
                        'chinese': ['"Ma Shan Zheng"', 'cursive'],
                        'body': ['"Sarabun"', '"Noto Sans Lao"', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f0f2f5;
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 20px 20px;
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }

        /* --- FLASHCARD STYLES (Stable) --- */
        .card-container {
            perspective: 1000px;
            width: 100%;
            height: 400px;
            position: relative;
        }
        
        .card-body {
            width: 100%;
            height: 100%;
            position: relative;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            border-radius: 1rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .card-container.flipped .card-body {
            transform: rotateY(180deg);
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 1rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: white;
            border: 1px solid #f3f4f6;
            overflow: hidden;
        }

        .card-front { z-index: 2; }
        .card-back {
            transform: rotateY(180deg);
            background: linear-gradient(135deg, #fff 0%, #fff5f5 100%);
            z-index: 1;
        }
        
        /* Writing Canvas */
        .writing-canvas {
            touch-action: none;
            cursor: crosshair;
            background-image: linear-gradient(to right, rgba(200,0,0,0.1) 1px, transparent 1px),
                              linear-gradient(to bottom, rgba(200,0,0,0.1) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        .btn-press:active { transform: scale(0.95); }
        .pb-safe { padding-bottom: max(1rem, env(safe-area-inset-bottom)); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Pulse animation for new cards */
        @keyframes pulse-subtle {
            0%, 100% { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
            50% { box-shadow: 0 10px 30px -5px rgba(230, 0, 18, 0.2); }
        }
        .pulse-subtle { animation: pulse-subtle 2s infinite; }
        
        .hidden-visually {
            display: none !important;
        }

        /* Loading Screen Animation */
        @keyframes loadProgress {
            0% { width: 0%; }
            100% { width: 100%; }
        }
        .animate-bounce-slow {
            animation: bounce 2s infinite;
        }
        
        /* Rank Badge Gradient */
        .rank-badge-bg {
            background: linear-gradient(135deg, #FFD700 0%, #FDB931 100%);
        }
    </style>
</head>
<body class="font-thai text-ink antialiased h-[100dvh] flex flex-col overflow-hidden">

    <!-- GAME-STYLE LOADING SCREEN -->
    <div id="game-loading-screen" class="fixed inset-0 z-[200] bg-paper flex flex-col items-center justify-center hidden transition-opacity duration-500">
        <div class="relative">
            <div class="absolute inset-0 bg-china-red blur-xl opacity-20 rounded-full animate-pulse"></div>
            <div class="w-24 h-24 bg-china-red rounded-full flex items-center justify-center text-white text-4xl font-chinese mb-8 shadow-xl relative z-10 animate-bounce-slow">‰∏≠</div>
        </div>
        
        <h2 class="text-3xl font-bold text-gray-800 mb-2 font-chinese tracking-widest">HSK 4 MASTER</h2>
        <p class="text-sm text-gray-500 mb-8" id="loading-status-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...</p>
        
        <div class="w-64 h-3 bg-gray-200 rounded-full overflow-hidden relative shadow-inner">
            <div id="loading-bar-fill" class="absolute top-0 left-0 h-full bg-china-red transition-all duration-300 ease-out" style="width: 0%"></div>
        </div>
        <div id="loading-percent" class="text-xs text-gray-400 mt-2 font-mono">0%</div>
    </div>

    <!-- LOGIN MODAL -->
    <div id="auth-modal" class="fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 fade-in">
        <div class="glass-panel p-8 rounded-3xl w-full max-w-sm text-center relative overflow-hidden transition-all duration-300">
            <div class="absolute top-0 left-0 w-full h-2 bg-china-red"></div>
            <div class="w-20 h-20 bg-china-red rounded-full mx-auto flex items-center justify-center text-white text-4xl font-chinese mb-4 shadow-lg">‰∏≠</div>
            <h2 class="text-2xl font-bold mb-1 text-gray-800">HSK 4 Masterclass</h2>
            <p class="text-sm text-gray-500 mb-6" data-i18n="app_subtitle">‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏µ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏£‡πà‡∏á‡∏£‡∏±‡∏î‡πÉ‡∏ô 1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
            
            <div class="space-y-4">
                <!-- Login Fields -->
                <div id="login-form-container" class="space-y-4">
                    <input type="email" id="login-email" class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-gray-50 focus:ring-2 focus:ring-china-red focus:bg-white outline-none transition" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏• (Email)...">
                    <input type="password" id="login-password" class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-gray-50 focus:ring-2 focus:ring-china-red focus:bg-white outline-none transition" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Password)...">
                    
                    <!-- Register-only Field -->
                    <input type="text" id="register-name" class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-gray-50 focus:ring-2 focus:ring-china-red focus:bg-white outline-none transition hidden-visually" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô (Display Name)...">

                    <button id="btn-submit-auth" onclick="window.auth.handleAuth()" class="w-full bg-china-red text-white py-3 rounded-xl font-bold shadow-lg hover:bg-red-700 btn-press transition flex items-center justify-center gap-2">
                        <span id="btn-text-auth">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span> <i class="fas fa-sign-in-alt"></i>
                    </button>
                    
                    <div class="text-sm text-gray-500 mt-2">
                        <span id="auth-toggle-text">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ?</span>
                        <button onclick="window.auth.toggleMode()" class="text-china-red font-bold hover:underline ml-1" id="auth-toggle-btn">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
                    </div>
                    
                    <div id="auth-error" class="text-red-600 text-xs text-center mt-2 hidden-visually bg-red-50 p-2 rounded-lg border border-red-200"></div>
                </div>
                
                <!-- Loading State (Mini Spinner removed, using full screen instead) -->
                <div id="auth-loading" class="hidden-visually flex flex-col items-center justify-center py-4">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-china-red mb-2"></div>
                    <span class="text-sm text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</span>
                </div>
            </div>
            
            <div class="flex justify-center gap-3 mt-6 border-t pt-4">
                <button onclick="window.auth.setLang('th')" class="text-2xl hover:scale-110 transition">üáπüá≠</button>
                <button onclick="window.auth.setLang('en')" class="text-2xl hover:scale-110 transition">üá¨üáß</button>
                <button onclick="window.auth.setLang('cn')" class="text-2xl hover:scale-110 transition">üá®üá≥</button>
                <button onclick="window.auth.setLang('la')" class="text-2xl hover:scale-110 transition">üá±üá¶</button>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app-container" class="hidden flex flex-col h-full">
        
        <!-- Mobile Navigation -->
        <nav class="fixed bottom-0 w-full bg-white border-t border-gray-200 z-50 md:hidden pb-safe">
            <div class="flex justify-around py-3 text-xs font-semibold text-gray-500">
                <button onclick="app.navigate('dashboard')" class="flex flex-col items-center gap-1 active:text-china-red nav-btn" data-target="dashboard">
                    <i class="fas fa-home text-xl"></i> <span data-i18n="nav_home">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
                </button>
                <button onclick="app.navigate('learn')" class="flex flex-col items-center gap-1 active:text-china-red nav-btn" data-target="learn">
                    <i class="fas fa-book-open text-xl"></i> <span data-i18n="nav_learn">‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>
                </button>
                <button onclick="app.navigate('practice')" class="flex flex-col items-center gap-1 active:text-china-red nav-btn" data-target="practice">
                    <i class="fas fa-dumbbell text-xl"></i> <span data-i18n="nav_practice">‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô</span>
                </button>
                <button onclick="app.navigate('profile')" class="flex flex-col items-center gap-1 active:text-china-red nav-btn" data-target="profile">
                    <i class="fas fa-user-astronaut text-xl"></i> <span data-i18n="nav_profile">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</span>
                </button>
            </div>
        </nav>

        <!-- Desktop Sidebar -->
        <aside class="hidden md:flex flex-col w-64 bg-white border-r h-full fixed left-0 top-0 z-50 shadow-lg">
            <div class="p-6 border-b flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-china-red flex items-center justify-center text-white font-bold text-xl font-chinese">‰∏≠</div>
                <div>
                    <h1 class="font-bold text-lg text-china-red">HSK 4 Master</h1>
                    <p class="text-xs text-gray-500">Global Edition</p>
                </div>
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <button onclick="app.navigate('dashboard')" class="w-full text-left px-4 py-3 rounded-xl hover:bg-red-50 hover:text-china-red transition flex items-center gap-3 nav-btn-desktop" data-target="dashboard">
                    <i class="fas fa-chart-pie w-6"></i> <span data-i18n="nav_home">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</span>
                </button>
                <button onclick="app.navigate('learn')" class="w-full text-left px-4 py-3 rounded-xl hover:bg-red-50 hover:text-china-red transition flex items-center gap-3 nav-btn-desktop" data-target="learn">
                    <i class="fas fa-layer-group w-6"></i> <span data-i18n="nav_learn">‡∏Ñ‡∏≠‡∏£‡πå‡∏™ 30 ‡∏ß‡∏±‡∏ô</span>
                </button>
                <button onclick="app.navigate('practice')" class="w-full text-left px-4 py-3 rounded-xl hover:bg-red-50 hover:text-china-red transition flex items-center gap-3 nav-btn-desktop" data-target="practice">
                    <i class="fas fa-brain w-6"></i> <span data-i18n="nav_practice">‡∏´‡πâ‡∏≠‡∏á‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô</span>
                </button>
                <button onclick="app.navigate('profile')" class="w-full text-left px-4 py-3 rounded-xl hover:bg-red-50 hover:text-china-red transition flex items-center gap-3 nav-btn-desktop" data-target="profile">
                    <i class="fas fa-cog w-6"></i> <span data-i18n="nav_profile">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
                </button>
            </nav>
        </aside>

        <!-- Main Content -->
        <main id="main-container" class="flex-1 md:ml-64 h-full overflow-y-auto pb-24 md:pb-0 scroll-smooth relative">
            <header class="sticky top-0 z-40 bg-white/80 backdrop-blur-md border-b px-6 py-4 flex justify-between items-center">
                <h2 id="page-title" class="text-xl font-bold text-gray-800">HSK 4</h2>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2 bg-red-100 text-china-red px-3 py-1 rounded-full text-sm font-bold">
                        <i class="fas fa-fire"></i> <span id="streak-counter">0</span> <span data-i18n="days">‡∏ß‡∏±‡∏ô</span>
                    </div>
                </div>
            </header>

            <div id="views" class="p-4 md:p-8 max-w-5xl mx-auto">
                
                <!-- Dashboard -->
                <div id="view-dashboard" class="space-y-6 fade-in">
                    <div class="bg-gradient-to-r from-china-red to-red-700 rounded-3xl p-6 md:p-10 text-white shadow-xl relative overflow-hidden">
                        <div class="absolute right-0 top-0 opacity-10 font-chinese text-9xl transform translate-x-10 -translate-y-10 select-none">Âä†Ê≤π</div>
                        <div class="relative z-10 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div>
                                <h3 class="text-3xl font-bold mb-2"><span data-i18n="hello">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ</span>, <span id="user-display-name">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>!</h3>
                                <p class="text-red-100 max-w-lg mb-2" data-i18n="dashboard_msg">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏û‡∏¥‡∏ä‡∏¥‡∏ï‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå HSK 4 ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 30 ‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á?</p>
                                
                                <!-- ADDED: Rank Display -->
                                <div class="inline-flex items-center gap-2 bg-black/20 px-3 py-1 rounded-lg text-sm text-white backdrop-blur-sm border border-white/20">
                                    <i class="fas fa-crown text-yellow-400"></i> <span id="user-rank-name">‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</span> <span class="opacity-50">|</span> <span id="user-level-display">Lv. 1</span>
                                </div>
                            </div>
                            
                            <button onclick="app.startDailySession()" class="bg-white text-china-red px-8 py-3 rounded-full font-bold shadow-lg hover:shadow-xl hover:scale-105 transition transform btn-press whitespace-nowrap">
                                <span data-i18n="start_today">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span> <i class="fas fa-arrow-right ml-2"></i>
                            </button>
                        </div>
                    </div>

                    <!-- ADDED: Level Progress Bar -->
                    <div class="glass-panel p-4 rounded-2xl flex items-center gap-4">
                        <div class="w-12 h-12 bg-china-gold rounded-full flex items-center justify-center text-white font-bold shadow-md rank-badge-bg">
                            <span id="progress-level-circle">1</span>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between text-xs text-gray-500 mb-1">
                                <span>XP Progress</span>
                                <span id="xp-text-display">0 / 100</span>
                            </div>
                            <div class="h-3 bg-gray-100 rounded-full overflow-hidden">
                                <div id="xp-progress-bar" class="h-full bg-china-gold transition-all duration-500" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="glass-panel p-4 rounded-2xl flex flex-col items-center justify-center">
                            <div class="text-3xl font-bold text-jade-dark mb-1" id="stat-learned">0</div>
                            <div class="text-xs text-gray-500" data-i18n="stat_learned">‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß</div>
                        </div>
                        <div class="glass-panel p-4 rounded-2xl flex flex-col items-center justify-center">
                            <div class="text-3xl font-bold text-china-gold mb-1" id="stat-mastered">0</div>
                            <div class="text-xs text-gray-500" data-i18n="stat_mastered">‡∏à‡∏≥‡πÅ‡∏°‡πà‡∏ô</div>
                        </div>
                        <div class="glass-panel p-4 rounded-2xl flex flex-col items-center justify-center">
                            <div class="text-3xl font-bold text-blue-600 mb-1" id="stat-accuracy">0%</div>
                            <div class="text-xs text-gray-500" data-i18n="stat_accuracy">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥</div>
                        </div>
                         <div class="glass-panel p-4 rounded-2xl flex flex-col items-center justify-center">
                            <div class="text-3xl font-bold text-purple-600 mb-1" id="stat-xp">0</div>
                            <div class="text-xs text-gray-500">XP Total</div>
                        </div>
                    </div>

                    <div>
                        <h4 class="font-bold text-lg mb-4 flex items-center gap-2">
                            <span class="w-1 h-6 bg-china-red rounded-full"></span> <span data-i18n="recommended">‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span>
                        </h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" id="daily-vocab-list"></div>
                    </div>
                </div>

                <!-- Learn -->
                <div id="view-learn" class="hidden space-y-6 fade-in">
                    <h3 class="text-2xl font-bold" data-i18n="course_map">‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô 30 ‡∏ß‡∏±‡∏ô</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="course-roadmap"></div>
                </div>

                <!-- Practice -->
                <div id="view-practice" class="hidden space-y-6 fade-in">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div onclick="app.startPractice('flashcard')" class="glass-panel p-6 rounded-3xl cursor-pointer hover:border-china-red transition group relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-4 opacity-20 group-hover:opacity-40 transition group-hover:scale-110 transform duration-500">
                                <i class="fas fa-clone text-8xl text-china-red"></i>
                            </div>
                            <h4 class="text-xl font-bold mb-2 group-hover:text-china-red">Flashcards</h4>
                            <p class="text-sm text-gray-500" data-i18n="desc_flashcard">‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏î‡πâ‡∏ß‡∏¢‡∏ö‡∏±‡∏ï‡∏£‡∏Ñ‡∏≥</p>
                        </div>
                        <div onclick="app.startPractice('writing')" class="glass-panel p-6 rounded-3xl cursor-pointer hover:border-jade-dark transition group relative overflow-hidden">
                             <div class="absolute top-0 right-0 p-4 opacity-20 group-hover:opacity-40 transition group-hover:scale-110 transform duration-500">
                                <i class="fas fa-pen-nib text-8xl text-jade-dark"></i>
                            </div>
                            <h4 class="text-xl font-bold mb-2 group-hover:text-jade-dark">Writing</h4>
                            <p class="text-sm text-gray-500" data-i18n="desc_writing">‡∏ù‡∏∂‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏à‡∏µ‡∏ô</p>
                        </div>
                        <div onclick="app.startPractice('quiz')" class="glass-panel p-6 rounded-3xl cursor-pointer hover:border-blue-500 transition group relative overflow-hidden">
                             <div class="absolute top-0 right-0 p-4 opacity-20 group-hover:opacity-40 transition group-hover:scale-110 transform duration-500">
                                <i class="fas fa-bolt text-8xl text-blue-500"></i>
                            </div>
                            <h4 class="text-xl font-bold mb-2 group-hover:text-blue-500">Speed Quiz</h4>
                            <p class="text-sm text-gray-500" data-i18n="desc_quiz">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏ß</p>
                        </div>
                    </div>
                </div>

                <!-- Profile -->
                <div id="view-profile" class="hidden space-y-6 fade-in">
                    <div class="glass-panel p-8 rounded-3xl text-center">
                        <div class="w-24 h-24 bg-china-red rounded-full mx-auto flex items-center justify-center text-white text-4xl font-chinese mb-4">Êàë</div>
                        <h3 class="text-2xl font-bold" id="profile-name-display">User</h3>
                        <p class="text-gray-500" id="profile-email-display">user@example.com</p>
                        
                        <!-- Profile Rank -->
                        <div class="mt-4 inline-block bg-yellow-100 text-yellow-700 px-4 py-2 rounded-full font-bold">
                            <span id="profile-rank-display">‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</span> (Lv. <span id="profile-level-display">1</span>)
                        </div>
                    </div>

                    <div class="glass-panel p-6 rounded-3xl space-y-6">
                        <h4 class="font-bold border-b pb-2" data-i18n="settings">‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h4>
                        
                        <div>
                            <label class="block text-sm text-gray-500 mb-1" data-i18n="change_name">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠</label>
                            <div class="flex gap-2">
                                <input type="text" id="setting-name" class="flex-1 border rounded-lg px-3 py-2 outline-none focus:border-china-red">
                                <button onclick="app.updateProfile()" class="bg-gray-800 text-white px-4 rounded-lg" data-i18n="save">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm text-gray-500 mb-1" data-i18n="change_lang">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏†‡∏≤‡∏©‡∏≤</label>
                            <div class="grid grid-cols-4 gap-2">
                                <button onclick="auth.changeLangInside('th')" class="p-2 border rounded hover:bg-gray-50">üáπüá≠</button>
                                <button onclick="auth.changeLangInside('en')" class="p-2 border rounded hover:bg-gray-50">üá¨üáß</button>
                                <button onclick="auth.changeLangInside('cn')" class="p-2 border rounded hover:bg-gray-50">üá®üá≥</button>
                                <button onclick="auth.changeLangInside('la')" class="p-2 border rounded hover:bg-gray-50">üá±üá¶</button>
                            </div>
                        </div>

                        <button onclick="window.auth.logout()" class="w-full text-red-600 border border-red-200 p-3 rounded-xl mt-4 hover:bg-red-50" data-i18n="logout">
                            ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- SESSION OVERLAY (Fixed Layout) -->
    <div id="session-overlay" class="fixed inset-0 bg-gray-100 z-[60] hidden flex flex-col">
        <div class="bg-white px-4 py-3 border-b flex justify-between items-center shadow-sm z-50">
            <button onclick="app.endSession()" class="text-gray-400 hover:text-red-500 transition"><i class="fas fa-times text-xl"></i></button>
            <div class="flex-1 mx-4">
                <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                    <div id="session-progress" class="h-full bg-china-red transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
            <div class="font-bold text-gray-700" id="session-counter">0/0</div>
        </div>

        <div id="session-content" class="flex-1 flex flex-col items-center justify-center p-4 relative overflow-y-auto w-full">
            
            <!-- FIXED FLASHCARD COMPONENT -->
            <div id="comp-flashcard" class="hidden w-full max-w-md h-[400px] card-container cursor-pointer" onclick="app.flipCard()">
                <div class="card-body bg-white">
                    <!-- Front -->
                    <div class="card-face card-front bg-white">
                        <span class="text-xs text-gray-400 absolute top-4 left-4" data-i18n="tap_flip">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÄ‡∏â‡∏•‡∏¢</span>
                        <button onclick="event.stopPropagation(); app.speak()" class="absolute top-4 right-4 text-gray-400 hover:text-china-red btn-press w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center border border-gray-200">
                            <i class="fas fa-volume-up"></i>
                        </button>
                        <div class="text-6xl md:text-8xl font-chinese text-ink mb-4" id="fc-hanzi"></div>
                        <div class="text-xl text-gray-500 font-serif" id="fc-pinyin"></div>
                    </div>
                    <!-- Back -->
                    <div class="card-face card-back">
                        <div class="text-4xl font-chinese text-china-red/10 absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2" id="fc-hanzi-bg"></div>
                        <div class="relative z-10 px-6 w-full text-center">
                            <h3 class="text-2xl font-bold text-gray-800 mb-4" id="fc-meaning"></h3>
                            <!-- Sentence Box -->
                            <div id="fc-sentence-box" class="bg-white/80 border-l-4 border-china-red p-3 text-left rounded shadow-sm">
                                <p class="text-lg text-gray-700 font-chinese mb-1" id="fc-sentence"></p>
                                <p class="text-xs text-gray-500" id="fc-sentence-meaning"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- WRITING -->
            <div id="comp-writing" class="hidden flex flex-col items-center w-full max-w-md">
                 <div class="flex justify-between w-full mb-2 px-2 items-center">
                    <span class="text-lg font-bold text-gray-700">‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô: <span id="wr-meaning" class="text-china-red"></span></span>
                    <button onclick="app.speak()" class="text-gray-400 hover:text-china-red"><i class="fas fa-volume-up"></i></button>
                 </div>
                 <div class="relative w-[300px] h-[300px] mx-auto bg-white rounded-xl shadow-lg border-2 border-gray-200">
                     <div id="wr-guide" class="absolute inset-0 flex items-center justify-center text-9xl font-chinese text-gray-200 pointer-events-none select-none z-0 opacity-0 transition-opacity duration-500"></div>
                     <canvas id="hanzi-canvas" width="300" height="300" class="writing-canvas z-10 relative w-full h-full rounded-xl"></canvas>
                 </div>
                 <div class="flex gap-4 mt-6 w-full">
                     <button onclick="app.writingCanvas.clear()" class="flex-1 py-3 rounded-xl bg-gray-200 font-bold text-gray-600 btn-press" data-i18n="clear">‡∏•‡∏ö</button>
                     <button onclick="app.revealWriting()" class="flex-1 py-3 rounded-xl bg-jade-light text-white font-bold shadow-lg btn-press" data-i18n="check">‡πÄ‡∏â‡∏•‡∏¢</button>
                 </div>
            </div>

            <!-- QUIZ -->
            <div id="comp-quiz" class="hidden w-full max-w-md">
                <div class="bg-white rounded-3xl p-8 shadow-xl text-center mb-6 relative">
                    <button onclick="app.speak()" class="absolute top-4 right-4 text-gray-300 hover:text-china-red"><i class="fas fa-volume-up"></i></button>
                    <div class="text-5xl font-chinese mb-2" id="qz-question"></div>
                </div>
                <div class="grid grid-cols-1 gap-3" id="qz-options"></div>
            </div>
        </div>

        <div id="session-controls" class="bg-white p-4 border-t hidden pb-safe z-50 shadow-inner">
            <div class="flex justify-between gap-3 max-w-md mx-auto">
                <button onclick="app.handleAnswer('hard')" class="flex-1 bg-red-100 text-red-600 py-3 rounded-xl font-bold hover:bg-red-200 btn-press">
                    <span data-i18n="hard">‡∏¢‡∏≤‡∏Å</span> <span class="block text-xs font-normal opacity-70">1 min</span>
                </button>
                <button onclick="app.handleAnswer('good')" class="flex-1 bg-blue-100 text-blue-600 py-3 rounded-xl font-bold hover:bg-blue-200 btn-press">
                    <span data-i18n="good">‡∏û‡∏≠‡πÑ‡∏î‡πâ</span> <span class="block text-xs font-normal opacity-70">10 mins</span>
                </button>
                <button onclick="app.handleAnswer('easy')" class="flex-1 bg-green-100 text-green-600 py-3 rounded-xl font-bold hover:bg-green-200 btn-press">
                    <span data-i18n="easy">‡∏á‡πà‡∏≤‡∏¢</span> <span class="block text-xs font-normal opacity-70">3 days</span>
                </button>
            </div>
        </div>
        
        <div id="session-next-btn" class="bg-white p-4 border-t hidden pb-safe z-50 shadow-inner">
            <button onclick="app.nextCard()" class="w-full bg-china-red text-white py-3 rounded-xl font-bold shadow-lg btn-press max-w-md mx-auto block">
                <span data-i18n="next">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</span> <i class="fas fa-chevron-right ml-1"></i>
            </button>
        </div>
    </div>

    <!-- MAIN LOGIC WITH FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyA_6-T3-xZXQNA4abv0U6onyYyHmrPbEP0",
            authDomain: "hsk4-web.firebaseapp.com",
            projectId: "hsk4-web",
            storageBucket: "hsk4-web.firebasestorage.app",
            messagingSenderId: "342394634384",
            appId: "1:342394634384:web:ceccfe5985498feda3d815"
        };

        const fbApp = initializeApp(firebaseConfig);
        const fbAuth = getAuth(fbApp);
        const fbDb = getFirestore(fbApp);
        // FIX: Use __app_id from environment if available, otherwise use config
        const appId = typeof __app_id !== 'undefined' ? __app_id : (firebaseConfig.projectId || "hsk4-web");

        // --- CONSTANTS ---
        const STORAGE_PREFIX = 'hsk4_masterclass_';
        const STORAGE_USER_DATA = STORAGE_PREFIX + 'user_data'; 

        // --- 1. LANGUAGE DATA ---
        const i18nData = {
            // ... (Same as before)
            th: {
                app_subtitle: "‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏µ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏£‡πà‡∏á‡∏£‡∏±‡∏î‡πÉ‡∏ô 1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", username: "‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ", start_learning: "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ", nav_home: "‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å", nav_learn: "‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", nav_practice: "‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô", nav_profile: "‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå", hello: "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ", dashboard_msg: "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏û‡∏¥‡∏ä‡∏¥‡∏ï‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå HSK 4 ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 30 ‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á?", start_today: "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ", stat_learned: "‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß", stat_mastered: "‡∏à‡∏≥‡πÅ‡∏°‡πà‡∏ô", stat_accuracy: "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥", recommended: "‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ", course_map: "‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô 30 ‡∏ß‡∏±‡∏ô", desc_flashcard: "‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏î‡πâ‡∏ß‡∏¢‡∏ö‡∏±‡∏ï‡∏£‡∏Ñ‡∏≥", desc_writing: "‡∏ù‡∏∂‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏à‡∏µ‡∏ô", desc_quiz: "‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏ß", settings: "‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤", change_name: "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠", change_lang: "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏†‡∏≤‡∏©‡∏≤", save: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å", logout: "‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö", tap_flip: "‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÄ‡∏â‡∏•‡∏¢", clear: "‡∏•‡∏ö", check: "‡πÄ‡∏â‡∏•‡∏¢ / ‡∏ï‡∏£‡∏ß‡∏à", hard: "‡∏¢‡∏≤‡∏Å / ‡∏à‡∏≥‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ", good: "‡∏û‡∏≠‡πÑ‡∏î‡πâ", easy: "‡∏á‡πà‡∏≤‡∏¢ / ‡∏à‡∏≥‡πÑ‡∏î‡πâ", next: "‡∏ñ‡∏±‡∏î‡πÑ‡∏õ", days: "‡∏ß‡∏±‡∏ô", login_btn: "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö", register_btn: "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å", no_account: "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ?", have_account: "‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß?", email_ph: "‡∏≠‡∏µ‡πÄ‡∏°‡∏• (Email)...", pass_ph: "‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Password)...",
                rank_1: "‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô", rank_2: "‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î", rank_3: "‡∏´‡∏ô‡∏≠‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠", rank_4: "‡∏ö‡∏±‡∏ì‡∏ë‡∏¥‡∏ï", rank_5: "‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå", rank_6: "‡∏õ‡∏£‡∏°‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå"
            },
            en: {
                app_subtitle: "The Ultimate Learning Experience", username: "Username", start_learning: "Start Learning", nav_home: "Home", nav_learn: "Course", nav_practice: "Practice", nav_profile: "Profile", hello: "Hello", dashboard_msg: "Ready to master HSK 4 in 30 days?", start_today: "Start Session", stat_learned: "Learned", stat_mastered: "Mastered", stat_accuracy: "Accuracy", recommended: "Recommended", course_map: "30-Day Roadmap", desc_flashcard: "SRS Review", desc_writing: "Stroke Order", desc_quiz: "Speed Quiz", settings: "Settings", change_name: "Display Name", change_lang: "Language", save: "Save", logout: "Logout", tap_flip: "Tap to Flip", clear: "Clear", check: "Reveal / Check", hard: "Hard", good: "Good", easy: "Easy", next: "Next", days: "Days", login_btn: "Login", register_btn: "Register", no_account: "No account?", have_account: "Have an account?", email_ph: "Email...", pass_ph: "Password...",
                rank_1: "Beginner", rank_2: "Apprentice", rank_3: "Bookworm", rank_4: "Scholar", rank_5: "Master", rank_6: "Grandmaster"
            },
            cn: {
                app_subtitle: "‰∏Ä‰∏™ÊúàÊéåÊè°HSK 4Á∫ßËØçÊ±á", username: "Áî®Êà∑Âêç", start_learning: "ÂºÄÂßãÂ≠¶‰π†", nav_home: "‰∏ªÈ°µ", nav_learn: "ËØæÁ®ã", nav_practice: "ÁªÉ‰π†", nav_profile: "ÊàëÁöÑ", hello: "‰Ω†Â•Ω", dashboard_msg: "ÂáÜÂ§áÂ•ΩÂú®30Â§©ÂÜÖÊéåÊè°HSK 4‰∫ÜÂêóÔºü", start_today: "‰ªäÊó•Â≠¶‰π†", stat_learned: "Â∑≤Â≠¶", stat_mastered: "ÊéåÊè°", stat_accuracy: "ÂáÜÁ°ÆÁéá", recommended: "‰ªäÊó•Êé®Ëçê", course_map: "30Â§©Â≠¶‰π†ËÆ°Âàí", desc_flashcard: "Âç°ÁâáÂ§ç‰π†", desc_writing: "Ê±âÂ≠ó‰π¶ÂÜô", desc_quiz: "Âø´ÈÄüÊµãÈ™å", settings: "ËÆæÁΩÆ", change_name: "ÊòæÁ§∫ÂêçÁß∞", change_lang: "ËØ≠Ë®Ä", save: "‰øùÂ≠ò", logout: "ÈÄÄÂá∫ÁôªÂΩï", tap_flip: "ÁÇπÂáªÁøªËΩ¨", clear: "Ê∏ÖÈô§", check: "Ê£ÄÊü•", hard: "Âõ∞Èöæ", good: "ËøòË°å", easy: "ÁÆÄÂçï", next: "‰∏ã‰∏Ä‰∏™", days: "Â§©", login_btn: "ÁôªÂΩï", register_btn: "Ê≥®ÂÜå", no_account: "Ê≤°ÊúâË¥¶Âè∑Ôºü", have_account: "Â∑≤ÊúâË¥¶Âè∑Ôºü", email_ph: "ÈÇÆÁÆ±...", pass_ph: "ÂØÜÁ†Å...",
                rank_1: "ÂàùÂ≠¶ËÄÖ", rank_2: "Â≠¶Âæí", rank_3: "‰π¶Ëô´", rank_4: "Â≠¶ËÄÖ", rank_5: "Â§ßÂ∏à", rank_6: "ÂÆóÂ∏à"
            },
            la: {
                app_subtitle: "‡∫Æ‡∫Ω‡∫ô‡∫û‡∫≤‡∫™‡∫≤‡∫à‡∫µ‡∫ô‡ªÅ‡∫ö‡∫ö‡ªÄ‡∫•‡∫±‡ªà‡∫á‡∫•‡∫±‡∫î‡∫û‡∫≤‡∫ç‡ªÉ‡∫ô 1 ‡ªÄ‡∫î‡∫∑‡∫≠‡∫ô", username: "‡∫ä‡∫∑‡ªà‡∫ú‡∫π‡ªâ‡ªÉ‡∫ä‡ªâ", start_learning: "‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡∫Æ‡∫Ω‡∫ô", nav_home: "‡ªú‡ªâ‡∫≤‡∫´‡∫º‡∫±‡∫Å", nav_learn: "‡∫ö‡∫ª‡∫î‡∫Æ‡∫Ω‡∫ô", nav_practice: "‡∫ù‡∫∂‡∫Å‡∫ù‡∫ª‡∫ô", nav_profile: "‡ªÇ‡∫õ‡∫£‡ªÑ‡∫ü‡∫•‡ªå", hello: "‡∫™‡∫∞‡∫ö‡∫≤‡∫ç‡∫î‡∫µ", dashboard_msg: "‡∫û‡ªâ‡∫≠‡∫°‡∫ó‡∫µ‡ªà‡∫à‡∫∞‡∫û‡∫¥‡∫ä‡∫¥‡∫î HSK 4 ‡∫û‡∫≤‡∫ç‡ªÉ‡∫ô 30 ‡∫°‡∫∑‡ªâ‡ªÅ‡∫•‡ªâ‡∫ß‡∫ö‡ªç?", start_today: "‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡∫°‡∫∑‡ªâ‡∫ô‡∫µ‡ªâ", stat_learned: "‡∫Æ‡∫Ω‡∫ô‡ªÅ‡∫•‡ªâ‡∫ß", stat_mastered: "‡∫à‡∫∑‡ªà‡ªÑ‡∫î‡ªâ‡ªÅ‡∫•‡ªâ‡∫ß", stat_accuracy: "‡∫Ñ‡∫ß‡∫≤‡∫°‡∫ñ‡∫∑‡∫Å‡∫ï‡ªâ‡∫≠‡∫á", recommended: "‡∫Ñ‡∫≥‡ªÅ‡∫ô‡∫∞‡∫ô‡∫≥‡∫°‡∫∑‡ªâ‡∫ô‡∫µ‡ªâ", course_map: "‡ªÅ‡∫ú‡∫ô‡∫Å‡∫≤‡∫ô‡∫Æ‡∫Ω‡∫ô 30 ‡∫°‡∫∑‡ªâ", desc_flashcard: "‡∫ó‡∫ª‡∫ö‡∫ó‡∫ß‡∫ô‡∫î‡ªâ‡∫ß‡∫ç SRS", desc_writing: "‡∫ù‡∫∂‡∫Å‡∫Ç‡∫Ω‡∫ô", desc_quiz: "‡∫ó‡∫ª‡∫î‡∫™‡∫≠‡∫ö‡∫Ñ‡∫ß‡∫≤‡∫°‡ªÑ‡∫ß", settings: "‡∫Å‡∫≤‡∫ô‡∫ï‡∫±‡ªâ‡∫á‡∫Ñ‡ªà‡∫≤", change_name: "‡∫õ‡ªà‡∫Ω‡∫ô‡∫ä‡∫∑‡ªà", change_lang: "‡∫û‡∫≤‡∫™‡∫≤", save: "‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å", logout: "‡∫≠‡∫≠‡∫Å‡∫à‡∫≤‡∫Å‡∫•‡∫∞‡∫ö‡∫ª‡∫ö", tap_flip: "‡ªÅ‡∫ï‡∫∞‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡ªÄ‡∫ö‡∫¥‡ªà‡∫á‡∫Ñ‡∫≥‡∫ï‡∫≠‡∫ö", clear: "‡∫•‡∫∂‡∫ö", check: "‡∫™‡∫∞‡ªÄ‡∫•‡∫µ‡∫ç", hard: "‡∫ç‡∫≤‡∫Å", good: "‡∫û‡ªç‡ªÑ‡∫î‡ªâ", easy: "‡∫á‡ªà‡∫≤‡∫ç", next: "‡∫ï‡ªç‡ªà‡ªÑ‡∫õ", days: "‡∫°‡∫∑‡ªâ", login_btn: "‡ªÄ‡∫Ç‡∫ª‡ªâ‡∫≤‡∫™‡∫π‡ªà‡∫•‡∫∞‡∫ö‡∫ª‡∫ö", register_btn: "‡∫•‡∫ª‡∫á‡∫ó‡∫∞‡∫ö‡∫Ω‡∫ô", no_account: "‡∫ç‡∫±‡∫á‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫ö‡∫±‡∫ô‡∫ä‡∫µ?", have_account: "‡∫°‡∫µ‡∫ö‡∫±‡∫ô‡∫ä‡∫µ‡ªÅ‡∫•‡ªâ‡∫ß?", email_ph: "‡∫≠‡∫µ‡ªÄ‡∫°‡∫ß...", pass_ph: "‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫ú‡ªà‡∫≤‡∫ô...",
                rank_1: "‡∫ú‡∫π‡ªâ‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡∫ï‡∫ª‡ªâ‡∫ô", rank_2: "‡∫ô‡∫±‡∫Å‡∫Æ‡∫Ω‡∫ô‡∫ù‡∫∂‡∫Å‡∫´‡∫±‡∫î", rank_3: "‡ªú‡∫≠‡∫ô‡ªú‡∫±‡∫á‡∫™‡∫∑", rank_4: "‡∫ö‡∫±‡∫ô‡∫î‡∫¥‡∫î", rank_5: "‡∫≠‡∫≤‡∫à‡∫≤‡∫ô", rank_6: "‡∫õ‡ªç‡∫•‡∫∞‡∫°‡∫≤‡∫à‡∫≤‡∫ô"
            }
        };

        // --- 2. MULTI-LANGUAGE VOCABULARY DATA ---
        const hsk4Data = [
            // ... (Same data)
            {
                id: 1, hanzi: "ÈòøÂß®", pinyin: "ƒÅy√≠",
                definitions: {
                    th: { meaning: "‡∏ô‡πâ‡∏≤, ‡∏õ‡πâ‡∏≤", sentence_meaning: "‡∏Ñ‡∏∏‡∏ì‡∏ô‡πâ‡∏≤‡∏Ñ‡∏∞ ‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà?" },
                    en: { meaning: "Aunt", sentence_meaning: "Auntie, how much is this dress?" },
                    cn: { meaning: "ÈòøÂß®", sentence_meaning: "ÈòøÂß®ÔºåËøô‰ª∂Ë°£ÊúçÂ§öÂ∞ëÈí±Ôºü" },
                    la: { meaning: "‡∫ô‡ªâ‡∫≤‡∫™‡∫≤‡∫ß, ‡∫õ‡ªâ‡∫≤", sentence_meaning: "‡∫ô‡ªâ‡∫≤‡∫™‡∫≤‡∫ß, ‡ªÄ‡∫™‡∫∑‡ªâ‡∫≠‡∫ô‡∫µ‡ªâ‡∫•‡∫≤‡∫Ñ‡∫≤‡ªÄ‡∫ó‡∫ª‡ªà‡∫≤‡ªÉ‡∫î?" }
                },
                sentence: "ÈòøÂß®ÔºåËøô‰ª∂Ë°£ÊúçÂ§öÂ∞ëÈí±Ôºü"
            },
            {
                id: 2, hanzi: "Áà±ÂõΩ", pinyin: "√†igu√≥",
                definitions: {
                    th: { meaning: "‡∏£‡∏±‡∏Å‡∏ä‡∏≤‡∏ï‡∏¥", sentence_meaning: "‡∏û‡∏•‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å‡∏ä‡∏≤‡∏ï‡∏¥" },
                    en: { meaning: "Patriotic", sentence_meaning: "Every citizen should be patriotic." },
                    cn: { meaning: "Áà±ÂõΩ", sentence_meaning: "ÊØè‰∏™ÂÖ¨Ê∞ëÈÉΩÂ∫îËØ•Áà±ÂõΩ„ÄÇ" },
                    la: { meaning: "‡∫Æ‡∫±‡∫Å‡∫ä‡∫≤‡∫î", sentence_meaning: "‡∫û‡∫ª‡∫ô‡∫•‡∫∞‡ªÄ‡∫°‡∫∑‡∫≠‡∫á‡∫ó‡∫∏‡∫Å‡∫Ñ‡∫ª‡∫ô‡∫Ñ‡∫ß‡∫ô‡∫Æ‡∫±‡∫Å‡∫ä‡∫≤‡∫î." }
                },
                sentence: "ÊØè‰∏™ÂÖ¨Ê∞ëÈÉΩÂ∫îËØ•Áà±ÂõΩ„ÄÇ"
            },
            {
                id: 3, hanzi: "Áà±Êä§", pinyin: "√†ih√π",
                definitions: {
                    th: { meaning: "‡∏£‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á", sentence_meaning: "‡∏û‡∏ß‡∏Å‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞" },
                    en: { meaning: "Cherish, Protect", sentence_meaning: "We must cherish public property." },
                    cn: { meaning: "Áà±Êä§", sentence_meaning: "Êàë‰ª¨Ë¶ÅÁà±Êä§ÂÖ¨Áâ©„ÄÇ" },
                    la: { meaning: "‡∫Æ‡∫±‡∫Å‡∫´‡∫≠‡∫°, ‡∫õ‡∫ª‡∫Å‡∫õ‡ªâ‡∫≠‡∫á", sentence_meaning: "‡∫û‡∫ß‡∫Å‡ªÄ‡∫Æ‡∫ª‡∫≤‡∫ï‡ªâ‡∫≠‡∫á‡∫ä‡ªà‡∫ß‡∫ç‡∫Å‡∫±‡∫ô‡∫õ‡∫ª‡∫Å‡∫õ‡∫±‡∫Å‡∫Æ‡∫±‡∫Å‡∫™‡∫≤‡∫Ç‡∫≠‡∫á‡∫™‡∫≤‡∫ó‡∫≤‡∫•‡∫∞‡∫ô‡∫∞." }
                },
                sentence: "Êàë‰ª¨Ë¶ÅÁà±Êä§ÂÖ¨Áâ©„ÄÇ"
            },
            {
                id: 4, hanzi: "ÂÆâ", pinyin: "√†n",
                definitions: {
                    th: { meaning: "‡∏™‡∏á‡∏ö, ‡∏™‡∏ö‡∏≤‡∏¢", sentence_meaning: "‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÇ‡∏î‡∏¢‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏†‡∏≤‡∏û" },
                    en: { meaning: "Safe, Calm", sentence_meaning: "Have a safe journey." },
                    cn: { meaning: "ÂÆâ", sentence_meaning: "Á•ù‰Ω†‰∏ÄË∑ØÂπ≥ÂÆâ„ÄÇ" },
                    la: { meaning: "‡∫™‡∫∞‡∫´‡∫á‡∫ª‡∫ö, ‡∫™‡∫∞‡∫ö‡∫≤‡∫ç", sentence_meaning: "‡∫Ç‡ªç‡ªÉ‡∫´‡ªâ‡ªÄ‡∫î‡∫µ‡∫ô‡∫ó‡∫≤‡∫á‡∫î‡ªâ‡∫ß‡∫ç‡∫Ñ‡∫ß‡∫≤‡∫°‡∫õ‡∫≠‡∫î‡ªÑ‡∫û." }
                },
                sentence: "Á•ù‰Ω†‰∏ÄË∑ØÂπ≥ÂÆâ„ÄÇ"
            },
            {
                id: 5, hanzi: "ÂÆâÁΩÆ", pinyin: "ƒÅnzh√¨",
                definitions: {
                    th: { meaning: "‡∏à‡∏±‡∏î‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å", sentence_meaning: "‡∏£‡∏±‡∏ê‡∏ö‡∏≤‡∏•‡πÑ‡∏î‡πâ‡∏à‡∏±‡∏î‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏†‡∏±‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°" },
                    en: { meaning: "Resettle", sentence_meaning: "The government properly resettled the victims." },
                    cn: { meaning: "ÂÆâÁΩÆ", sentence_meaning: "ÊîøÂ∫úÂ¶•ÂñÑÂÆâÁΩÆ‰∫ÜÁÅæÊ∞ë„ÄÇ" },
                    la: { meaning: "‡∫à‡∫±‡∫î‡∫´‡∫≤‡∫ö‡ªà‡∫≠‡∫ô‡∫¢‡∫π‡ªà", sentence_meaning: "‡∫•‡∫±‡∫î‡∫ñ‡∫∞‡∫ö‡∫≤‡∫ô‡ªÑ‡∫î‡ªâ‡∫à‡∫±‡∫î‡∫´‡∫≤‡∫ö‡ªà‡∫≠‡∫ô‡∫¢‡∫π‡ªà‡ªÉ‡∫´‡ªâ‡∫ú‡∫π‡ªâ‡∫õ‡∫∞‡∫™‡∫ª‡∫ö‡ªÑ‡∫û‡∫¢‡ªà‡∫≤‡∫á‡ªÄ‡ªù‡∫≤‡∫∞‡∫™‡∫ª‡∫°." }
                },
                sentence: "ÊîøÂ∫úÂ¶•ÂñÑÂÆâÁΩÆ‰∫ÜÁÅæÊ∞ë„ÄÇ"
            },
            {
                id: 6, hanzi: "ÊåâÊó∂", pinyin: "√†nsh√≠",
                definitions: {
                    th: { meaning: "‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤", sentence_meaning: "‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤" },
                    en: { meaning: "On time", sentence_meaning: "Please hand in your homework on time." },
                    cn: { meaning: "ÊåâÊó∂", sentence_meaning: "ËØ∑Â§ßÂÆ∂ÊåâÊó∂‰∫§‰Ωú‰∏ö„ÄÇ" },
                    la: { meaning: "‡∫Å‡∫ª‡∫á‡ªÄ‡∫ß‡∫•‡∫≤", sentence_meaning: "‡∫Ç‡ªç‡ªÉ‡∫´‡ªâ‡∫ó‡∫∏‡∫Å‡∫Ñ‡∫ª‡∫ô‡∫™‡∫ª‡ªà‡∫á‡∫ß‡∫Ω‡∫Å‡∫ö‡ªâ‡∫≤‡∫ô‡ªÉ‡∫´‡ªâ‡∫Å‡∫ª‡∫á‡ªÄ‡∫ß‡∫•‡∫≤." }
                },
                sentence: "ËØ∑Â§ßÂÆ∂ÊåâÊó∂‰∫§‰Ωú‰∏ö„ÄÇ"
            },
            {
                id: 7, hanzi: "Êöó", pinyin: "√†n",
                definitions: {
                    th: { meaning: "‡∏°‡∏∑‡∏î", sentence_meaning: "‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏°‡∏∑‡∏î‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡πÄ‡∏ñ‡∏≠‡∏∞" },
                    en: { meaning: "Dark", sentence_meaning: "It's too dark in the room, turn on the light." },
                    cn: { meaning: "Êöó", sentence_meaning: "ÊàøÈó¥ÈáåÂ§™Êöó‰∫ÜÔºåÂºÄÁÅØÂêß„ÄÇ" },
                    la: { meaning: "‡∫°‡∫∑‡∫î", sentence_meaning: "‡ªÉ‡∫ô‡∫´‡ªâ‡∫≠‡∫á‡∫°‡∫∑‡∫î‡ªÇ‡∫û‡∫î‡ªÅ‡∫•‡ªâ‡∫ß, ‡ªÄ‡∫õ‡∫µ‡∫î‡ªÑ‡∫ü‡ªÅ‡∫î‡ªà." }
                },
                sentence: "ÊàøÈó¥ÈáåÂ§™Êöó‰∫ÜÔºåÂºÄÁÅØÂêß„ÄÇ"
            },
            {
                id: 8, hanzi: "ÊöóÁ§∫", pinyin: "√†nsh√¨",
                definitions: {
                    th: { meaning: "‡∏ö‡∏≠‡∏Å‡πÉ‡∏ö‡πâ", sentence_meaning: "‡πÄ‡∏Ç‡∏≤‡∏ö‡∏≠‡∏Å‡πÉ‡∏ö‡πâ‡πÉ‡∏´‡πâ‡∏â‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏π‡∏î‡∏≠‡∏∞‡πÑ‡∏£" },
                    en: { meaning: "Hint", sentence_meaning: "He hinted for me not to speak." },
                    cn: { meaning: "ÊöóÁ§∫", sentence_meaning: "‰ªñÊöóÁ§∫Êàë‰∏çË¶ÅËØ¥ËØù„ÄÇ" },
                    la: { meaning: "‡∫ö‡∫≠‡∫Å‡ªÉ‡∫ö‡ªâ", sentence_meaning: "‡∫•‡∫≤‡∫ß‡∫ö‡∫≠‡∫Å‡ªÉ‡∫ö‡ªâ‡ªÉ‡∫´‡ªâ‡∫Ç‡ªâ‡∫≠‡∫ç‡∫ö‡ªç‡ªà‡∫ï‡ªâ‡∫≠‡∫á‡ªÄ‡∫ß‡∫ª‡ªâ‡∫≤‡∫´‡∫ç‡∫±‡∫á." }
                },
                sentence: "‰ªñÊöóÁ§∫Êàë‰∏çË¶ÅËØ¥ËØù„ÄÇ"
            },
            {
                id: 9, hanzi: "ÂåÖÂ≠ê", pinyin: "bƒÅozi",
                definitions: {
                    th: { meaning: "‡∏ã‡∏≤‡∏•‡∏≤‡πÄ‡∏õ‡∏≤", sentence_meaning: "‡∏â‡∏±‡∏ô‡∏≠‡∏¢‡∏≤‡∏Å‡∏Å‡∏¥‡∏ô‡∏ã‡∏≤‡∏•‡∏≤‡πÄ‡∏õ‡∏≤‡πÑ‡∏™‡πâ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠" },
                    en: { meaning: "Steamed Bun", sentence_meaning: "I want to eat meat buns." },
                    cn: { meaning: "ÂåÖÂ≠ê", sentence_meaning: "ÊàëÊÉ≥ÂêÉËÇâÂåÖÂ≠ê„ÄÇ" },
                    la: { meaning: "‡∫ä‡∫≤‡∫•‡∫≤‡ªÄ‡∫õ‡∫ª‡∫≤", sentence_meaning: "‡∫Ç‡ªâ‡∫≠‡∫ç‡∫¢‡∫≤‡∫Å‡∫Å‡∫¥‡∫ô‡∫ä‡∫≤‡∫•‡∫≤‡ªÄ‡∫õ‡∫ª‡∫≤‡∫ä‡∫µ‡ªâ‡∫ô." }
                },
                sentence: "ÊàëÊÉ≥ÂêÉËÇâÂåÖÂ≠ê„ÄÇ"
            },
            {
                id: 10, hanzi: "‰øùÊä§", pinyin: "b«éoh√π",
                definitions: {
                    th: { meaning: "‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á", sentence_meaning: "‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°" },
                    en: { meaning: "Protect", sentence_meaning: "We must protect the environment." },
                    cn: { meaning: "‰øùÊä§", sentence_meaning: "Êàë‰ª¨Ë¶Å‰øùÊä§ÁéØÂ¢É„ÄÇ" },
                    la: { meaning: "‡∫õ‡∫ª‡∫Å‡∫õ‡ªâ‡∫≠‡∫á", sentence_meaning: "‡∫û‡∫ß‡∫Å‡ªÄ‡∫Æ‡∫ª‡∫≤‡∫ï‡ªâ‡∫≠‡∫á‡∫ä‡ªà‡∫ß‡∫ç‡∫Å‡∫±‡∫ô‡∫Æ‡∫±‡∫Å‡∫™‡∫≤‡∫™‡∫¥‡ªà‡∫á‡ªÅ‡∫ß‡∫î‡∫•‡ªâ‡∫≠‡∫°." }
                },
                sentence: "Êàë‰ª¨Ë¶Å‰øùÊä§ÁéØÂ¢É„ÄÇ"
            },
            {
                id: 11, hanzi: "‰øùËØÅ", pinyin: "b«éozh√®ng",
                definitions: {
                    th: { meaning: "‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á", sentence_meaning: "‡∏â‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏™‡∏≤‡∏¢‡∏≠‡∏µ‡∏Å" },
                    en: { meaning: "Guarantee", sentence_meaning: "I guarantee I won't be late again." },
                    cn: { meaning: "‰øùËØÅ", sentence_meaning: "Êàë‰øùËØÅ‰ª•Âêé‰∏çÂÜçËøüÂà∞„ÄÇ" },
                    la: { meaning: "‡∫Æ‡∫±‡∫ö‡∫õ‡∫∞‡∫Å‡∫±‡∫ô", sentence_meaning: "‡∫Ç‡ªâ‡∫≠‡∫ç‡∫Æ‡∫±‡∫ö‡∫õ‡∫∞‡∫Å‡∫±‡∫ô‡∫ß‡ªà‡∫≤‡∫°‡∫∑‡ªâ‡ªú‡ªâ‡∫≤‡∫à‡∫∞‡∫ö‡ªç‡ªà‡∫°‡∫≤‡∫ä‡ªâ‡∫≤‡∫≠‡∫µ‡∫Å." }
                },
                sentence: "Êàë‰øùËØÅ‰ª•Âêé‰∏çÂÜçËøüÂà∞„ÄÇ"
            },
            {
                id: 12, hanzi: "Êä±Ê≠â", pinyin: "b√†oqi√†n",
                definitions: {
                    th: { meaning: "‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©", sentence_meaning: "‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏ô‡∏≤‡∏ô" },
                    en: { meaning: "Sorry", sentence_meaning: "So sorry to keep you waiting." },
                    cn: { meaning: "Êä±Ê≠â", sentence_meaning: "ÈùûÂ∏∏Êä±Ê≠âÔºåËÆ©‰Ω†‰πÖÁ≠â‰∫Ü„ÄÇ" },
                    la: { meaning: "‡∫Ç‡ªç‡ªÇ‡∫ó‡∫î", sentence_meaning: "‡∫Ç‡ªç‡ªÇ‡∫ó‡∫î‡ªÅ‡∫ó‡ªâ‡ªÜ ‡∫ó‡∫µ‡ªà‡ªÉ‡∫´‡ªâ‡∫•‡ªç‡∫ñ‡ªâ‡∫≤‡∫î‡∫ª‡∫ô." }
                },
                sentence: "ÈùûÂ∏∏Êä±Ê≠âÔºåËÆ©‰Ω†‰πÖÁ≠â‰∫Ü„ÄÇ"
            },
            {
                id: 13, hanzi: "Êä•ÈÅì", pinyin: "b√†od√†o",
                definitions: {
                    th: { meaning: "‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô(‡∏Ç‡πà‡∏≤‡∏ß)", sentence_meaning: "‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡πà‡∏≤‡∏ß‡∏ä‡∏¥‡πâ‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏°‡∏≤‡∏Å" },
                    en: { meaning: "Report", sentence_meaning: "This report is written very well." },
                    cn: { meaning: "Êä•ÈÅì", sentence_meaning: "ËøôÁØáÊä•ÈÅìÂÜôÂæóÂæàÂ•Ω„ÄÇ" },
                    la: { meaning: "‡∫•‡∫≤‡∫ç‡∫á‡∫≤‡∫ô(‡∫Ç‡ªà‡∫≤‡∫ß)", sentence_meaning: "‡∫ö‡∫ª‡∫î‡∫•‡∫≤‡∫ç‡∫á‡∫≤‡∫ô‡∫ô‡∫µ‡ªâ‡∫Ç‡∫Ω‡∫ô‡ªÑ‡∫î‡ªâ‡∫î‡∫µ‡∫´‡∫º‡∫≤‡∫ç." }
                },
                sentence: "ËøôÁØáÊä•ÈÅìÂÜôÂæóÂæàÂ•Ω„ÄÇ"
            },
            {
                id: 14, hanzi: "Êä•Âêç", pinyin: "b√†om√≠ng",
                definitions: {
                    th: { meaning: "‡∏™‡∏°‡∏±‡∏Ñ‡∏£", sentence_meaning: "‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏•‡∏á‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡πÑ‡∏´‡∏°?" },
                    en: { meaning: "Sign up", sentence_meaning: "Are you signing up for the competition?" },
                    cn: { meaning: "Êä•Âêç", sentence_meaning: "‰Ω†Ë¶ÅÊä•ÂêçÂèÇÂä†ÊØîËµõÂêóÔºü" },
                    la: { meaning: "‡∫•‡∫ª‡∫á‡∫ó‡∫∞‡∫ö‡∫Ω‡∫ô", sentence_meaning: "‡ªÄ‡∫à‡∫ª‡ªâ‡∫≤‡∫à‡∫∞‡∫•‡∫ª‡∫á‡∫™‡∫∞‡ªù‡∫±‡∫Å‡ªÅ‡∫Ç‡ªà‡∫á‡∫Ç‡∫±‡∫ô‡∫ö‡ªç?" }
                },
                sentence: "‰Ω†Ë¶ÅÊä•ÂêçÂèÇÂä†ÊØîËµõÂêóÔºü"
            },
            {
                id: 15, hanzi: "ÂÄç", pinyin: "b√®i",
                definitions: {
                    th: { meaning: "‡πÄ‡∏ó‡πà‡∏≤(‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)", sentence_meaning: "‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏õ‡∏µ‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏™‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤" },
                    en: { meaning: "Times (multiplier)", sentence_meaning: "Production doubled this year." },
                    cn: { meaning: "ÂÄç", sentence_meaning: "‰ªäÂπ¥ÁöÑ‰∫ßÈáèÂ¢ûÂä†‰∫Ü‰∏§ÂÄç„ÄÇ" },
                    la: { meaning: "‡ªÄ‡∫ó‡∫ª‡ªà‡∫≤", sentence_meaning: "‡∫ú‡∫ª‡∫ô‡∫ú‡∫∞‡∫•‡∫¥‡∫î‡∫õ‡∫µ‡∫ô‡∫µ‡ªâ‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫Ç‡∫∂‡ªâ‡∫ô‡∫™‡∫≠‡∫á‡ªÄ‡∫ó‡∫ª‡ªà‡∫≤." }
                },
                sentence: "‰ªäÂπ¥ÁöÑ‰∫ßÈáèÂ¢ûÂä†‰∫Ü‰∏§ÂÄç„ÄÇ"
            },
            {
                id: 19, hanzi: "ÊØï‰∏ö", pinyin: "b√¨y√®",
                definitions: {
                    th: { meaning: "‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤", sentence_meaning: "‡∏â‡∏±‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏à‡∏ö‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏õ‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß" },
                    en: { meaning: "Graduate", sentence_meaning: "I am graduating from university next year." },
                    cn: { meaning: "ÊØï‰∏ö", sentence_meaning: "ÊàëÊòéÂπ¥Â∞±Ë¶ÅÂ§ßÂ≠¶ÊØï‰∏ö‰∫Ü„ÄÇ" },
                    la: { meaning: "‡∫à‡∫ª‡∫ö‡∫Å‡∫≤‡∫ô‡∫™‡∫∂‡∫Å‡∫™‡∫≤", sentence_meaning: "‡∫Ç‡ªâ‡∫≠‡∫ç‡∫Å‡∫≥‡∫•‡∫±‡∫á‡∫à‡∫∞‡∫à‡∫ª‡∫ö‡∫°‡∫∞‡∫´‡∫≤‡∫ß‡∫¥‡∫ó‡∫∞‡∫ç‡∫≤‡ªÑ‡∫•‡∫õ‡∫µ‡ªú‡ªâ‡∫≤‡∫ô‡∫µ‡ªâ‡ªÅ‡∫•‡ªâ‡∫ß." }
                },
                sentence: "ÊàëÊòéÂπ¥Â∞±Ë¶ÅÂ§ßÂ≠¶ÊØï‰∏ö‰∫Ü„ÄÇ"
            },
            {
                id: 35, hanzi: "Áåú", pinyin: "cƒÅi",
                definitions: {
                    th: { meaning: "‡πÄ‡∏î‡∏≤", sentence_meaning: "‡∏Ñ‡∏∏‡∏ì‡∏•‡∏≠‡∏á‡πÄ‡∏î‡∏≤‡∏î‡∏π‡∏™‡∏¥ ‡∏ß‡πà‡∏≤‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?" },
                    en: { meaning: "Guess", sentence_meaning: "Take a guess, what's in the box?" },
                    cn: { meaning: "Áåú", sentence_meaning: "‰Ω†ÁåúÁåúÁúãÔºåÁõíÂ≠êÈáåÊòØ‰ªÄ‰πàÔºü" },
                    la: { meaning: "‡ªÄ‡∫î‡∫ª‡∫≤", sentence_meaning: "‡ªÄ‡∫à‡∫ª‡ªâ‡∫≤‡∫•‡∫≠‡∫á‡ªÄ‡∫î‡∫ª‡∫≤‡ªÄ‡∫ö‡∫¥‡ªà‡∫á‡∫î‡∫∏ ‡∫ß‡ªà‡∫≤‡ªÉ‡∫ô‡∫Å‡ªà‡∫≠‡∫á‡ªÅ‡∫°‡ªà‡∫ô‡∫´‡∫ç‡∫±‡∫á?" }
                },
                sentence: "‰Ω†ÁåúÁåúÁúãÔºåÁõíÂ≠êÈáåÊòØ‰ªÄ‰πàÔºü"
            },
            {
                id: 907, hanzi: "Áõ¥Êí≠", pinyin: "zh√≠b≈ç",
                definitions: {
                    th: { meaning: "‡∏ñ‡πà‡∏≤‡∏¢‡∏ó‡∏≠‡∏î‡∏™‡∏î", sentence_meaning: "‡∏Å‡∏≤‡∏£‡πÑ‡∏•‡∏ü‡πå‡∏™‡∏î‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏¥‡∏¢‡∏°‡∏°‡∏≤‡∏Å" },
                    en: { meaning: "Live Stream", sentence_meaning: "Live streaming is very popular." },
                    cn: { meaning: "Áõ¥Êí≠", sentence_meaning: "Áõ¥Êí≠ÈùûÂ∏∏ÊµÅË°å„ÄÇ" },
                    la: { meaning: "‡∫ñ‡ªà‡∫≤‡∫ç‡∫ó‡∫≠‡∫î‡∫™‡∫ª‡∫î", sentence_meaning: "‡∫Å‡∫≤‡∫ô‡ªÑ‡∫•‡∫ü‡ªå‡∫™‡∫ª‡∫î‡∫Å‡∫≥‡∫•‡∫±‡∫á‡ªÄ‡∫õ‡∫±‡∫ô‡∫ó‡∫µ‡ªà‡∫ô‡∫¥‡∫ç‡∫ª‡∫°‡∫´‡∫º‡∫≤‡∫ç." }
                },
                sentence: "Áõ¥Êí≠ÈùûÂ∏∏ÊµÅË°å„ÄÇ"
            },
            {
                id: 910, hanzi: "ÂÄºÂæó", pinyin: "zh√≠d√©",
                definitions: {
                    th: { meaning: "‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡πà‡∏≤", sentence_meaning: "‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏•‡πà‡∏°‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ã‡∏∑‡πâ‡∏≠" },
                    en: { meaning: "Worth it", sentence_meaning: "This book is worth buying." },
                    cn: { meaning: "ÂÄºÂæó", sentence_meaning: "ËøôÊú¨‰π¶ÂÄºÂæó‰π∞„ÄÇ" },
                    la: { meaning: "‡∫Ñ‡∫∏‡ªâ‡∫°‡∫Ñ‡ªà‡∫≤", sentence_meaning: "‡∫õ‡∫∂‡ªâ‡∫°‡∫´‡∫ª‡∫ß‡∫ô‡∫µ‡ªâ‡∫Ñ‡∫∏‡ªâ‡∫°‡∫Ñ‡ªà‡∫≤‡∫ó‡∫µ‡ªà‡∫à‡∫∞‡∫ä‡∫∑‡ªâ." }
                },
                sentence: "ËøôÊú¨‰π¶ÂÄºÂæó‰π∞„ÄÇ"
            }
        ];

        // --- 3. SOUND EFFECT SYSTEM ---
        class SoundManager {
            constructor() { this.ctx = null; }
            init() {
                if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                if(this.ctx.state === 'suspended') this.ctx.resume();
            }
            playTone(freq, type, duration) {
                this.init(); if(!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type; osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(0.02, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.00001, this.ctx.currentTime + duration);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + duration);
            }
            playClick() { this.playTone(600, 'sine', 0.05); }
            playCorrect() { this.playTone(800, 'sine', 0.1); setTimeout(() => this.playTone(1200, 'sine', 0.1), 100); }
            playWrong() { this.playTone(200, 'triangle', 0.2); }
            playWin() { [500, 700, 900].forEach((f, i) => setTimeout(() => this.playTone(f, 'sine', 0.1), i * 100)); }
        }

        // --- 4. CLOUD SYNC & AUTH ---
        class CloudSyncManager {
            constructor() {
                this.timer = null;
                this.enabled = true;
                this.pending = false;
            }

            save(user, immediate = false) {
                if(!user) return;
                user.updatedAt = Date.now(); 
                localStorage.setItem(STORAGE_USER_DATA, JSON.stringify(user));
                
                if(this.enabled && user.uid) {
                    clearTimeout(this.timer);
                    this.pending = true;
                    
                    if(immediate) {
                        this.pushToCloud(user);
                    } else {
                        this.timer = setTimeout(() => {
                            this.pushToCloud(user);
                        }, 500); // Reduced to 0.5s for faster sync
                    }
                }
            }

            async pushToCloud(user) {
                try {
                    const userRef = doc(fbDb, 'artifacts', appId, 'users', user.uid, 'app_data', 'profile');
                    await setDoc(userRef, user, { merge: true });
                    this.pending = false;
                    console.log("Cloud synced");
                } catch(e) {
                    console.error("Cloud sync failed (offline?)", e);
                }
            }
            
            handleIncomingData(docSnap, appInstance) {
                if (!docSnap.exists()) return;
                const cloudData = docSnap.data();
                const localDataString = localStorage.getItem(STORAGE_USER_DATA);
                let merged = cloudData;
                if (localDataString) {
                    const localData = JSON.parse(localDataString);
                    // Ensure cloud has priority unless local is explicitly newer and different
                    if (localData.updatedAt && cloudData.updatedAt && localData.updatedAt > cloudData.updatedAt) {
                        this.pushToCloud(localData);
                        return; 
                    }
                }
                localStorage.setItem(STORAGE_USER_DATA, JSON.stringify(merged));
                appInstance.loadUser(merged);
            }
        }

        class AuthManager {
            constructor() { 
                this.currentUser = null; 
                this.userDocUnsubscribe = null;
                this.lang = 'th'; 
                this.isRegisterMode = false;
            }

            setLang(l) { 
                this.lang = l; 
                this.applyLang(); 
                if (!this.currentUser) localStorage.setItem(STORAGE_PREFIX + 'global_lang', this.lang);
                
                if(window.app && window.app.user) {
                    window.app.renderDashboard(); 
                }
            }

            applyLang() {
                const t = i18nData[this.lang];
                if (!t) return;

                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.dataset.i18n;
                    if (t[key]) el.innerText = t[key];
                });

                const loginBtn = document.getElementById('btn-text-auth');
                if (loginBtn) loginBtn.innerText = this.isRegisterMode ? t.register_btn : t.login_btn;
                
                const toggleText = document.getElementById('auth-toggle-text');
                if (toggleText) toggleText.innerText = this.isRegisterMode ? t.have_account : t.no_account;
                
                const toggleBtn = document.getElementById('auth-toggle-btn');
                if (toggleBtn) toggleBtn.innerText = this.isRegisterMode ? t.login_btn : t.register_btn;

                const emailInput = document.getElementById('login-email');
                if (emailInput) emailInput.placeholder = t.email_ph || "Email...";
                
                const passInput = document.getElementById('login-password');
                if (passInput) passInput.placeholder = t.pass_ph || "Password...";
            }

            toggleMode() {
                this.isRegisterMode = !this.isRegisterMode;
                const regName = document.getElementById('register-name');
                if (this.isRegisterMode) {
                    regName.classList.remove('hidden-visually');
                } else {
                    regName.classList.add('hidden-visually');
                }
                this.applyLang();
                document.getElementById('auth-error').classList.add('hidden-visually');
            }

            loadFromLocal() {
                const localStr = localStorage.getItem(STORAGE_USER_DATA);
                if (localStr) {
                    try {
                        const localUser = JSON.parse(localStr);
                        if(localUser) {
                            this.currentUser = localUser;
                            app.loadUser(localUser);
                            app.startLoadingSequence(true); 
                            document.getElementById('auth-modal').classList.add('hidden');
                            document.getElementById('app-container').classList.remove('hidden');
                        }
                    } catch(e) { console.error("Local load error", e); }
                }
            }

            async handleAuth() {
                const email = document.getElementById('login-email').value.trim();
                const password = document.getElementById('login-password').value.trim();
                const errorDiv = document.getElementById('auth-error');
                
                errorDiv.classList.add('hidden-visually');
                if (!email || !password) {
                    errorDiv.innerText = "Please enter email and password";
                    errorDiv.classList.remove('hidden-visually');
                    return;
                }

                sound.init();
                app.startLoadingSequence(false); 

                try {
                    if (this.isRegisterMode) {
                        const name = document.getElementById('register-name').value.trim() || "Student";
                        const result = await createUserWithEmailAndPassword(fbAuth, email, password);
                        await updateProfile(result.user, { displayName: name });
                        
                        // Force save new user data immediately
                        const newUser = {
                            name: name,
                            xp: 0,
                            streak: 0,
                            lastStudyDate: "",
                            progress: {},
                            settings: { lang: this.lang },
                            uid: result.user.uid,
                            email: result.user.email,
                            updatedAt: Date.now()
                        };
                        this.currentUser = newUser;
                        cloudSync.save(newUser, true);
                    } else {
                        await signInWithEmailAndPassword(fbAuth, email, password);
                    }
                } catch (error) {
                    let msg = error.message;
                    if (error.code === 'auth/wrong-password') msg = "‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
                    else if (error.code === 'auth/user-not-found') msg = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ";
                    app.stopLoading();
                    errorDiv.innerText = msg;
                    errorDiv.classList.remove('hidden-visually');
                }
            }

            async logout() { 
                // Show loading UI
                const loadingScreen = document.getElementById('game-loading-screen');
                const barFill = document.getElementById('loading-bar-fill');
                const percentText = document.getElementById('loading-percent');
                const statusText = document.getElementById('loading-status-text');
                
                if(loadingScreen) {
                    loadingScreen.classList.remove('hidden');
                    loadingScreen.style.opacity = '1';
                    if(statusText) statusText.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î... (Saving Data)";
                    
                    // Simulate progress while saving
                    let p = 0;
                    const interval = setInterval(() => {
                        p += 5;
                        if(p > 90) p = 90; // Hold at 90 until done
                        if(barFill) barFill.style.width = `${p}%`;
                        if(percentText) percentText.innerText = `${p}%`;
                    }, 50);
                    
                    // Force sync with timeout race
                    if (this.currentUser) {
                        const syncPromise = cloudSync.pushToCloud(this.currentUser);
                        const timeoutPromise = new Promise(resolve => setTimeout(resolve, 3000));
                        await Promise.race([syncPromise, timeoutPromise]);
                    }
                    
                    // Done saving
                    clearInterval(interval);
                    if(barFill) barFill.style.width = '100%';
                    if(percentText) percentText.innerText = '100%';
                    if(statusText) statusText.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö... (Logging out)";
                }

                if (this.userDocUnsubscribe) this.userDocUnsubscribe();
                
                setTimeout(() => {
                    signOut(fbAuth).then(() => {
                       localStorage.removeItem(STORAGE_USER_DATA);
                       location.reload(); 
                    });
                }, 500); // Short delay to see 100%
            }
            
            saveSettings(data) {
                if (!this.currentUser || !this.currentUser.uid) return;
                const mergedUser = { ...this.currentUser, ...data };
                if(data.settings) mergedUser.settings = { ...this.currentUser.settings, ...data.settings };
                this.currentUser = mergedUser;
                cloudSync.save(mergedUser, true); // Immediate save
                if(data.name) document.getElementById('user-display-name').innerText = data.name;
            }

            changeLangInside(l) { 
                this.setLang(l); 
                this.saveSettings({ settings: { lang: l } }); 
                if (!this.currentUser) return;
                this.currentUser.settings = { ...this.currentUser.settings, lang: l };
                cloudSync.save(this.currentUser, true); // Immediate save
            }
        }

        // --- 5. MAIN APP LOGIC ---
        class App {
            constructor() {
                this.user = null; 
                this.sessionQueue = []; 
                this.currentCardIndex = 0;
                this.mode = 'flashcard'; 
                // Fix: Initialize with dummy object to prevent crash if setup fails
                this.writingCanvas = { clear: () => {} }; 
                this.canvasInitialized = false; // Add initialization flag
                this.synthVoice = null; 
                this.isGuideRevealed = false;
                
                this.loadingInterval = null;
                this.isLoadingVisible = false;
            }

            getLocalized(word) {
                if (!word) return { meaning: "", sentence_meaning: "" };
                const lang = auth.lang || 'th';
                
                if (word.definitions && word.definitions[lang]) {
                    return word.definitions[lang];
                }
                
                if (word.definitions && word.definitions['en']) return word.definitions['en'];
                
                return { meaning: word.meaning, sentence_meaning: word.sentence_meaning };
            }

            startLoadingSequence(isFast = false) {
                if (this.isLoadingVisible) return;
                this.isLoadingVisible = true;
                const loadingScreen = document.getElementById('game-loading-screen');
                const barFill = document.getElementById('loading-bar-fill');
                const percentText = document.getElementById('loading-percent');
                
                loadingScreen.classList.remove('hidden');
                document.getElementById('auth-modal').classList.add('hidden'); 
                
                let progress = 0;
                const increment = isFast ? 5 : 1; 
                const speed = isFast ? 20 : 50;   
                
                clearInterval(this.loadingInterval);
                this.loadingInterval = setInterval(() => {
                    if (progress > 80 && !isFast && !this.user) progress += 0.2; 
                    else progress += increment;
                    
                    if (progress >= 100) {
                        progress = 100;
                        clearInterval(this.loadingInterval);
                        setTimeout(() => this.stopLoading(), 300);
                    }
                    barFill.style.width = `${Math.min(100, progress)}%`;
                    percentText.innerText = `${Math.round(Math.min(100, progress))}%`;
                }, speed);
            }
            
            stopLoading() {
                const loadingScreen = document.getElementById('game-loading-screen');
                loadingScreen.style.opacity = '0';
                setTimeout(() => {
                    loadingScreen.classList.add('hidden');
                    loadingScreen.style.opacity = '1'; 
                    this.isLoadingVisible = false;
                    document.getElementById('app-container').classList.remove('hidden');
                }, 500);
            }

            init() {
                // this.setupCanvas(); // Removed immediate setup
                this.initVoice();
                const globalLang = localStorage.getItem(STORAGE_PREFIX + 'global_lang');
                if(globalLang) auth.setLang(globalLang);
                else auth.setLang('th'); 

                auth.loadFromLocal();

                onAuthStateChanged(fbAuth, async (firebaseUser) => {
                    if (firebaseUser) {
                        if (!this.user) this.startLoadingSequence(false); 
                        const userRef = doc(fbDb, 'artifacts', appId, 'users', firebaseUser.uid, 'app_data', 'profile');
                        auth.userDocUnsubscribe = onSnapshot(userRef, (docSnap) => {
                            if (docSnap.exists()) {
                                cloudSync.handleIncomingData(docSnap, this);
                                const barFill = document.getElementById('loading-bar-fill');
                                if (barFill && this.isLoadingVisible) barFill.style.width = '100%';
                            } else {
                                const initialData = {
                                    name: firebaseUser.displayName || "New Student",
                                    xp: 0,
                                    streak: 0,
                                    lastStudyDate: "",
                                    progress: {},
                                    settings: { lang: auth.lang },
                                    uid: firebaseUser.uid,
                                    email: firebaseUser.email,
                                    updatedAt: Date.now()
                                };
                                cloudSync.save(initialData, true); // Immediate Save
                                this.loadUser(initialData);
                            }
                        });
                        document.getElementById('auth-modal').classList.add('hidden');
                    } else {
                        document.getElementById('auth-modal').classList.remove('hidden');
                        document.getElementById('app-container').classList.add('hidden');
                        document.getElementById('game-loading-screen').classList.add('hidden'); 
                        document.getElementById('login-form-container').classList.remove('hidden-visually');
                        document.getElementById('auth-loading').classList.add('hidden-visually');
                    }
                });
            }

            loadUser(userData) {
                this.user = userData;
                auth.currentUser = userData;
                if(userData.settings && userData.settings.lang) auth.setLang(userData.settings.lang);
                
                document.getElementById('user-display-name').innerText = userData.name;
                document.getElementById('profile-name-display').innerText = userData.name;
                document.getElementById('profile-email-display').innerText = userData.email || "";
                document.getElementById('setting-name').value = userData.name;
                
                this.updateStats(false); 
                this.renderDashboard(); 
                this.navigate('dashboard');
            }

            calculateLevel(xp) {
                if(!xp) return { level: 1, nextXp: 100, currentLevelXp: 0 };
                const level = Math.floor(xp / 100) + 1;
                const nextXp = level * 100;
                const currentLevelXp = xp % 100;
                return { level, nextXp, currentLevelXp, needed: 100 };
            }

            getRankName(level) {
                const rankKey = level <= 1 ? "rank_1" : 
                                level <= 3 ? "rank_2" : 
                                level <= 5 ? "rank_3" :
                                level <= 10 ? "rank_4" :
                                level <= 20 ? "rank_5" : "rank_6";
                return i18nData[auth.lang]?.[rankKey] || i18nData['th'][rankKey];
            }

            updateStats(shouldSave = true) {
                if (!this.user) return;
                const learned = Object.keys(this.user.progress || {}).length;
                const mastered = Object.values(this.user.progress || {}).filter(l => l >= 3).length;
                const accuracy = learned > 0 ? Math.round((mastered / learned) * 100) : 0;
                const streak = this.user.streak || 0;
                
                document.getElementById('stat-learned').innerText = learned;
                document.getElementById('stat-mastered').innerText = mastered;
                document.getElementById('stat-accuracy').innerText = `${accuracy}%`;
                document.getElementById('stat-xp').innerText = this.user.xp || 0;
                document.getElementById('streak-counter').innerText = streak;
                
                if (shouldSave) {
                    this.user.streak = streak;
                    this.user.lastStudyDate = this.user.lastStudyDate;
                    cloudSync.save(this.user);
                }
            }
            
            checkStreak() {
                const today = new Date().toDateString();
                const lastStudy = this.user.lastStudyDate || '';
                
                if (lastStudy !== today) {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayStr = yesterday.toDateString();
                    if (lastStudy === yesterdayStr) this.user.streak = (this.user.streak || 0) + 1;
                    else this.user.streak = 1;
                    this.user.lastStudyDate = today;
                    this.updateStats(true); 
                }
            }

            updateProfile() {
                const newName = document.getElementById('setting-name').value.trim();
                if(!newName) return alert("Please enter a name");
                const currentUser = fbAuth.currentUser;
                if (!currentUser) return alert("Please login first");
                this.user.name = newName;
                document.getElementById('user-display-name').innerText = newName;
                cloudSync.save(this.user, true); // Immediate Save
                alert(i18nData[auth.lang]?.save || "Saved!");
            }

            navigate(target) {
                sound.playClick();
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    const isTarget = btn.dataset.target === target;
                    btn.classList.toggle('text-china-red', isTarget);
                    btn.classList.toggle('text-gray-500', !isTarget);
                });
                document.querySelectorAll('.nav-btn-desktop').forEach(btn => {
                    const isTarget = btn.dataset.target === target;
                    btn.classList.toggle('bg-red-50', isTarget);
                    btn.classList.toggle('text-china-red', isTarget);
                    btn.classList.toggle('text-gray-700', !isTarget);
                });
                ['dashboard', 'learn', 'practice', 'profile'].forEach(v => {
                    document.getElementById(`view-${v}`).classList.add('hidden');
                });
                document.getElementById(`view-${target}`).classList.remove('hidden');
                if(target === 'learn') this.renderCourseMap();
            }

            renderDashboard() {
                if (!this.user) return; 
                const unlearned = hsk4Data.filter(w => !this.user.progress || !this.user.progress[w.id]);
                const list = document.getElementById('daily-vocab-list');
                list.innerHTML = '';
                
                unlearned.slice(0, 6).forEach(word => {
                    const div = document.createElement('div');
                    div.className = 'bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex items-center justify-between hover:border-china-red transition cursor-pointer pulse-subtle';
                    div.innerHTML = `
                        <div>
                            <div class="font-chinese text-2xl text-ink">${word.hanzi}</div>
                            <div class="text-xs text-gray-500">${word.pinyin}</div>
                        </div>
                        <div class="w-8 h-8 rounded-full bg-red-50 text-china-red flex items-center justify-center">
                            <i class="fas fa-play text-xs"></i>
                        </div>
                    `;
                    div.onclick = () => { 
                        sound.playClick(); 
                        this.quickStudy(word.id); 
                    };
                    list.appendChild(div);
                });

                const xp = this.user.xp || 0;
                const levelInfo = this.calculateLevel(xp);
                const rankName = this.getRankName(levelInfo.level);
                
                document.getElementById('user-rank-name').innerText = rankName;
                document.getElementById('user-level-display').innerText = `Lv. ${levelInfo.level}`;
                
                document.getElementById('progress-level-circle').innerText = levelInfo.level;
                document.getElementById('xp-text-display').innerText = `${levelInfo.currentLevelXp} / ${levelInfo.needed} XP`;
                document.getElementById('xp-progress-bar').style.width = `${(levelInfo.currentLevelXp / levelInfo.needed) * 100}%`;
                
                document.getElementById('profile-rank-display').innerText = rankName;
                document.getElementById('profile-level-display').innerText = levelInfo.level;
            }

            renderCourseMap() {
                const container = document.getElementById('course-roadmap'); 
                container.innerHTML = '';
                const learnedCount = Object.keys(this.user?.progress || {}).length;
                const currentDay = Math.min(30, Math.floor(learnedCount / 20) + 1);
                
                for(let i = 1; i <= 30; i++) {
                    const isLocked = i > currentDay;
                    const isCurrent = i === currentDay;
                    const isCompleted = i < currentDay;
                    
                    const div = document.createElement('div');
                    div.className = `p-6 rounded-2xl border-2 flex flex-col justify-between h-32 relative overflow-hidden transition ${
                        isLocked ? 'bg-gray-100 border-gray-200 text-gray-400' : 
                        isCurrent ? 'bg-white border-china-red shadow-lg cursor-pointer hover:scale-105' :
                        'bg-white border-green-100 shadow-sm cursor-pointer hover:scale-105'
                    }`;
                    
                    div.innerHTML = `
                        <span class="font-bold text-xl">Day ${i}</span>
                        ${isLocked ? '<i class="fas fa-lock text-gray-400"></i>' : 
                          isCurrent ? '<span class="px-3 py-1 bg-china-red text-white text-xs rounded-lg">‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</span>' :
                          '<span class="px-3 py-1 bg-green-100 text-green-700 text-xs rounded-lg">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</span>'}
                    `;
                    
                    if(!isLocked) {
                        div.onclick = () => { 
                            sound.playClick(); 
                            this.startDailySession(); 
                        };
                    }
                    container.appendChild(div);
                }
            }

            startDailySession() {
                if (!this.user) return; 
                const progress = this.user.progress || {};
                const unlearned = hsk4Data.filter(w => !progress[w.id]);
                this.sessionQueue = unlearned.length > 0 ? 
                    unlearned.slice(0, 10) : 
                    hsk4Data.sort(() => 0.5 - Math.random()).slice(0, 10);
                this.mode = 'flashcard'; 
                this.startSessionUI();
            }
            
            startPractice(m) {
                if (!this.user) return; 
                this.mode = m; 
                
                // ADDED: Lazy load canvas for writing mode
                if (m === 'writing' && !this.canvasInitialized) {
                    this.setupCanvas();
                }

                const progress = this.user.progress || {};
                const learned = hsk4Data.filter(w => progress[w.id]);
                const pool = learned.length > 0 ? learned : hsk4Data.slice(0, 5);
                this.sessionQueue = pool.sort(() => 0.5 - Math.random()).slice(0, 10);
                this.startSessionUI();
            }
            
            quickStudy(id) {
                this.sessionQueue = [hsk4Data.find(w => w.id === id)];
                this.mode = 'flashcard'; 
                this.startSessionUI();
            }
            
            startSessionUI() {
                if(this.sessionQueue.length === 0) {
                    return alert(i18nData[auth.lang]?.start_today || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô!");
                }
                this.currentCardIndex = 0;
                
                const overlay = document.getElementById('session-overlay');
                if (overlay) overlay.classList.remove('hidden');
                
                ['comp-flashcard', 'comp-writing', 'comp-quiz'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.classList.add('hidden');
                });
                
                const controls = document.getElementById('session-controls');
                if (controls) controls.classList.add('hidden');
                
                const nextBtn = document.getElementById('session-next-btn');
                if (nextBtn) nextBtn.classList.add('hidden');
                
                this.renderCard();
            }

            renderCard() {
                const word = this.sessionQueue[this.currentCardIndex];
                if(!word) return;
                
                // ADDED: Localized content fetch
                const localContent = this.getLocalized(word);

                const counter = document.getElementById('session-counter');
                if (counter) counter.innerText = `${this.currentCardIndex + 1}/${this.sessionQueue.length}`;
                
                const progress = document.getElementById('session-progress');
                if (progress) progress.style.width = `${((this.currentCardIndex)/this.sessionQueue.length)*100}%`;
                
                if(this.mode === 'writing' && this.writingCanvas) {
                    this.writingCanvas.clear();
                    this.isGuideRevealed = false;
                }
                
                if(this.mode === 'flashcard') {
                    const cardComp = document.getElementById('comp-flashcard');
                    if (cardComp) {
                        cardComp.classList.remove('hidden');
                        cardComp.classList.remove('flipped'); 
                    }
                    
                    const hanziEl = document.getElementById('fc-hanzi');
                    if (hanziEl) hanziEl.innerText = word.hanzi;
                    
                    const pinyinEl = document.getElementById('fc-pinyin');
                    if (pinyinEl) pinyinEl.innerText = word.pinyin;
                    
                    const hanziBg = document.getElementById('fc-hanzi-bg');
                    if (hanziBg) hanziBg.innerText = word.hanzi;
                    
                    // MODIFIED: Use Localized Meaning
                    const meaningEl = document.getElementById('fc-meaning');
                    if (meaningEl) meaningEl.innerText = localContent.meaning;
                    
                    const sentenceBox = document.getElementById('fc-sentence-box');
                    if(word.sentence) {
                        if (sentenceBox) sentenceBox.classList.remove('hidden');
                        const sentEl = document.getElementById('fc-sentence');
                        if (sentEl) sentEl.innerText = word.sentence;
                        // MODIFIED: Use Localized Sentence Meaning
                        const sentMeanEl = document.getElementById('fc-sentence-meaning');
                        if (sentMeanEl) sentMeanEl.innerText = localContent.sentence_meaning;
                    } else {
                        if (sentenceBox) sentenceBox.classList.add('hidden');
                    }
                    
                    const controls = document.getElementById('session-controls');
                    if (controls) controls.classList.remove('hidden');
                    
                    const nextBtn = document.getElementById('session-next-btn');
                    if (nextBtn) nextBtn.classList.add('hidden');

                } else if (this.mode === 'writing') {
                    const writingComp = document.getElementById('comp-writing');
                    if (writingComp) writingComp.classList.remove('hidden');
                    // MODIFIED: Use Localized Meaning
                    const wrMeanEl = document.getElementById('wr-meaning');
                    if (wrMeanEl) wrMeanEl.innerText = localContent.meaning;
                    
                    const wrGuide = document.getElementById('wr-guide');
                    if (wrGuide) {
                        wrGuide.innerText = word.hanzi;
                        wrGuide.style.opacity = '0';
                        wrGuide.classList.remove('text-china-red'); 
                    }
                    
                    const controls = document.getElementById('session-controls');
                    if (controls) controls.classList.remove('hidden');
                    
                    const nextBtn = document.getElementById('session-next-btn');
                    if (nextBtn) nextBtn.classList.add('hidden');
                
                } else if (this.mode === 'quiz') {
                    const quizComp = document.getElementById('comp-quiz');
                    if (quizComp) quizComp.classList.remove('hidden');
                    
                    const quizQ = document.getElementById('qz-question');
                    if (quizQ) quizQ.innerText = word.hanzi;
                    
                    const container = document.getElementById('qz-options'); 
                    if (container) {
                        container.innerHTML = '';
                        
                        let choices = [word];
                        while(choices.length < 4) { 
                            const r = hsk4Data[Math.floor(Math.random() * hsk4Data.length)]; 
                            if(!choices.find(c => c.id === r.id)) choices.push(r); 
                        }
                        choices.sort(() => 0.5 - Math.random());
                        
                        choices.forEach(c => {
                            const btn = document.createElement('button');
                            btn.className = 'w-full text-left p-4 rounded-xl border border-gray-200 hover:bg-red-50 hover:border-china-red transition font-thai text-lg btn-press';
                            // MODIFIED: Use Localized Meaning for choices
                            btn.innerText = this.getLocalized(c).meaning;
                            
                            btn.onclick = () => {
                                if(btn.classList.contains('answered')) return;
                                if(c.id === word.id) {
                                    sound.playCorrect();
                                    if('vibrate' in navigator) navigator.vibrate(50);
                                    btn.classList.add('bg-green-100', 'border-green-500', 'text-green-700', 'answered');
                                    setTimeout(() => this.handleAnswer('good'), 800);
                                } else {
                                    sound.playWrong();
                                    if('vibrate' in navigator) navigator.vibrate(200);
                                    btn.classList.add('bg-red-100', 'border-red-500', 'text-red-700', 'answered');
                                }
                            };
                            container.appendChild(btn);
                        });
                    }
                    
                    const controls = document.getElementById('session-controls');
                    if (controls) controls.classList.add('hidden');
                    
                    const nextBtn = document.getElementById('session-next-btn');
                    if (nextBtn) nextBtn.classList.add('hidden');
                }
            }

            flipCard() { 
                sound.playClick(); 
                const card = document.getElementById('comp-flashcard');
                if (card) card.classList.toggle('flipped'); 
            }

            handleAnswer(quality) {
                const word = this.sessionQueue[this.currentCardIndex];
                if(!word) return;
                if (!this.user.progress) this.user.progress = {};
                let lvl = this.user.progress[word.id] || 0;
                
                if (quality === 'hard') {
                    lvl = Math.max(0, lvl - 1);
                    this.user.xp = (this.user.xp || 0) + 2;
                } else if (quality === 'good') {
                    lvl += 1;
                    this.user.xp = (this.user.xp || 0) + 5;
                } else if (quality === 'easy') {
                    lvl += 2;
                    this.user.xp = (this.user.xp || 0) + 10;
                }
                this.user.progress[word.id] = lvl; 
                
                const controls = document.getElementById('session-controls');
                if (controls) controls.classList.add('hidden');
                
                const nextBtn = document.getElementById('session-next-btn');
                if (nextBtn) nextBtn.classList.remove('hidden');
            }

            nextCard() {
                sound.playClick();
                this.currentCardIndex++;
                if(this.currentCardIndex >= this.sessionQueue.length) { 
                    sound.playWin();
                    if('vibrate' in navigator) navigator.vibrate([100, 50, 100]);
                    this.checkStreak(); 
                    this.endSession();
                } else { 
                    this.renderCard(); 
                }
            }

            endSession() {
                const overlay = document.getElementById('session-overlay');
                if (overlay) overlay.classList.add('hidden');
                this.updateStats(true); 
                this.renderDashboard();
                this.triggerConfetti();
            }
            
            triggerConfetti() {
                if (typeof confetti === 'function') {
                    var count = 200;
                    var defaults = { origin: { y: 0.7 } };
                    function fire(particleRatio, opts) {
                        confetti(Object.assign({}, defaults, opts, {
                            particleCount: Math.floor(count * particleRatio)
                        }));
                    }
                    fire(0.25, { spread: 26, startVelocity: 55, });
                    fire(0.2, { spread: 60, });
                    fire(0.35, { spread: 100, decay: 0.91, scalar: 0.8 });
                    fire(0.1, { spread: 120, startVelocity: 25, decay: 0.92, scalar: 1.2 });
                    fire(0.1, { spread: 120, startVelocity: 45, });
                }
            }

            setupCanvas() {
                const canvas = document.getElementById('hanzi-canvas'); 
                if (!canvas) {
                    // Fail silently or handle gracefully, will be retried when user enters writing mode
                    return;
                }
                const ctx = canvas.getContext('2d');
                let isDrawing = false;
                let lastX = 0;
                let lastY = 0;
                ctx.lineWidth = 14; 
                ctx.lineCap = 'round'; 
                ctx.lineJoin = 'round'; 
                ctx.strokeStyle = '#2c2c2c';
                
                const getPos = (e) => {
                    const rect = canvas.getBoundingClientRect();
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    return { 
                        x: (clientX - rect.left) * (canvas.width / rect.width), 
                        y: (clientY - rect.top) * (canvas.height / rect.height) 
                    };
                };
                
                const startDrawing = (e) => { 
                    e.preventDefault(); 
                    isDrawing = true;
                    const pos = getPos(e);
                    lastX = pos.x;
                    lastY = pos.y;
                    ctx.beginPath();
                    ctx.moveTo(lastX, lastY);
                };
                
                const draw = (e) => { 
                    e.preventDefault(); 
                    if(!isDrawing) return; 
                    const pos = getPos(e);
                    ctx.lineTo(pos.x, pos.y);
                    ctx.stroke();
                    lastX = pos.x;
                    lastY = pos.y;
                };
                
                const stopDrawing = () => { 
                    isDrawing = false;
                    ctx.closePath();
                };
                
                canvas.addEventListener('mousedown', startDrawing);
                canvas.addEventListener('mousemove', draw);
                canvas.addEventListener('mouseup', stopDrawing);
                canvas.addEventListener('mouseout', stopDrawing);
                canvas.addEventListener('touchstart', startDrawing, {passive: false});
                canvas.addEventListener('touchmove', draw, {passive: false});
                canvas.addEventListener('touchend', stopDrawing);
                
                this.writingCanvas = { 
                    clear: () => {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.beginPath();
                    }
                };
                this.canvasInitialized = true;
            }

            revealWriting() {
                sound.playClick();
                const guide = document.getElementById('wr-guide');
                if(!this.isGuideRevealed) { 
                    if (guide) {
                        guide.style.opacity = '0.4'; 
                        guide.classList.add('text-china-red'); 
                    }
                    this.isGuideRevealed = true; 
                } else { 
                    if (guide) {
                        guide.style.opacity = '0'; 
                        guide.classList.remove('text-china-red');
                    }
                    this.isGuideRevealed = false; 
                }
            }

            initVoice() {
                const voices = window.speechSynthesis.getVoices();
                if(voices.length > 0) {
                    this.synthVoice = voices.find(v => v.lang === 'zh-CN' || v.lang === 'zh-TW');
                }
                window.speechSynthesis.onvoiceschanged = () => {
                    const updatedVoices = window.speechSynthesis.getVoices();
                    this.synthVoice = updatedVoices.find(v => v.lang === 'zh-CN' || v.lang === 'zh-TW');
                };
            }
            
            speak() {
                try {
                    const word = this.sessionQueue[this.currentCardIndex];
                    if (!word || !('speechSynthesis' in window)) return;
                    window.speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(word.hanzi);
                    utterance.lang = 'zh-CN';
                    utterance.rate = 0.8;
                    utterance.pitch = 1.0;
                    if (this.synthVoice) utterance.voice = this.synthVoice;
                    utterance.onerror = (event) => console.log("Speech synthesis error:", event);
                    window.speechSynthesis.speak(utterance);
                } catch (error) {
                    console.log("Speech error:", error);
                }
            }
        }

        // --- INITIALIZE APP ---
        const sound = new SoundManager();
        const app = new App();
        const auth = new AuthManager();
        const cloudSync = new CloudSyncManager();

        window.app = app;
        window.auth = auth;
        window.sound = sound;
        window.cloudSync = cloudSync;
        
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });

    </script>
</body>
</html>
