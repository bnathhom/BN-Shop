<!DOCTYPE html>
<html lang="lo">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BN Shop Order System</title>
  <style>
    body { font-family: 'Noto Sans Lao', sans-serif; padding: 20px; }
    h1 { text-align: center; }
    .order-form, .order-list { margin: 20px auto; max-width: 500px; border: 1px solid #ccc; padding: 20px; border-radius: 8px; }
    .form-control { margin-bottom: 10px; }
    .form-control label { display: block; margin-bottom: 5px; }
    .form-control input, .form-control textarea, .form-control select { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
    .btn { padding: 10px 20px; border: none; border-radius: 5px; background-color: #007BFF; color: white; cursor: pointer; margin: 5px; }
    .btn-danger { background-color: #dc3545; }
    .btn-success { background-color: #28a745; }
    .order { border: 1px dashed #aaa; padding: 10px; margin: 10px 0; position: relative; }
    .order input[type=checkbox] { position: absolute; right: 10px; top: 10px; }
    .print-btns { margin-top: 20px; text-align: center; }
    .bill { width: 76mm; height: auto; min-height: 130mm; padding: 10px; font-size: 14px; box-sizing: border-box; border: 1px solid #000; margin: 0 auto; overflow: hidden; }
    .logo { font-size: 48px; font-weight: bold; display: inline-block; vertical-align: middle; margin-right: 10px; }
    .shop-info { display: inline-block; vertical-align: middle; line-height: 1.4; white-space: nowrap; }
    .header { margin-bottom: 10px; }
    .section { margin-top: 10px; }
    .barcode-container { text-align: center; margin: 15px 0; }
    .barcode-number { text-align: center; font-family: monospace; font-size: 12px; margin-top: 5px; }
    .thankyou { text-align: center; margin-top: 20px; font-weight: bold; }
    .customer-pre, .bill pre { 
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: 'Noto Sans Lao', sans-serif;
      margin: 0;
      line-height: 1.4;
    }
    #auth-section { display: none; }
    #loading { text-align: center; margin: 20px; }
    .sync-status {
      position: fixed;
      bottom: 10px;
      right: 10px;
      padding: 5px 10px;
      border-radius: 5px;
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
    }
  </style>
</head>
<body>
  <h1>BN Shop Order System</h1>
  
  <!-- Loading Indicator -->
  <div id="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö...</div>
  
  <!-- Authentication Section -->
  <div class="order-form" id="auth-section">
    <h2>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö / ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
    <div class="form-control">
      <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
      <input type="email" id="email" placeholder="example@email.com">
    </div>
    <div class="form-control">
      <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
      <input type="password" id="password" placeholder="‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£">
    </div>
    <button class="btn btn-success" id="signInBtn">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    <button class="btn" id="signUpBtn">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
  </div>

  <!-- User Info Section -->
  <div id="user-info" class="order-form" style="display: none;">
    <p>üë§ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏î‡∏¢: <span id="user-email"></span></p>
    <button class="btn btn-danger" id="signOutBtn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
  </div>

  <!-- Order Form (shown after login) -->
  <div class="order-form" id="order-form-section" style="display: none;">
    <div class="form-control">
      <label>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
      <textarea id="customerData" rows="4"></textarea>
    </div>
    <div class="form-control">
      <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏ô‡∏™‡πà‡∏á</label>
      <select id="courier">
        <option value="HAL LOGISTICS">HAL LOGISTICS</option>
        <option value="Anousith Express">Anousith Express</option>
        <option value="Mixay Express">Mixay Express</option>
      </select>
    </div>
    <div class="form-control">
      <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏£‡πâ‡∏≤‡∏ô (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏Ç‡∏ô‡∏™‡πà‡∏á)</label>
      <select id="shopPhone" disabled>
        <option value="020 94036226">020 94036226</option>
        <option value="020 98052744">020 98052744</option>
      </select>
    </div>
    <button class="btn btn-success" id="addOrderBtn">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
  </div>

  <!-- Order List (shown after login) -->
  <div class="order-list" id="order-list-section" style="display: none;">
    <h2>‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
    <div id="orders"></div>
    <div class="print-btns">
      <button class="btn" id="printSelectedBtn">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
      <button class="btn" id="printAllBtn">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      <button class="btn" id="syncOrdersBtn">‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå</button>
    </div>
  </div>

  <!-- Sync Status -->
  <div class="sync-status" id="sync-status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>

  <!-- Firebase and Barcode Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { 
      getAuth, 
      createUserWithEmailAndPassword, 
      signInWithEmailAndPassword, 
      signOut, 
      onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { 
      getDatabase, 
      ref, 
      set, 
      push, 
      onValue,
      update,
      remove
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAR4ZN_J3u4nTl2dLpF6eXqE3txaUoYrMY",
      authDomain: "bnchen-93d9d.firebaseapp.com",
      databaseURL: "https://bnchen-93d9d-default-rtdb.firebaseio.com",
      projectId: "bnchen-93d9d",
      storageBucket: "bnchen-93d9d.appspot.com",
      messagingSenderId: "1047651812089",
      appId: "1:1047651812089:web:6f520fa528059cc43e1828",
      measurementId: "G-WK259X0ZQ1"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // DOM Elements
    const elements = {
      loading: document.getElementById('loading'),
      authSection: document.getElementById('auth-section'),
      userInfo: document.getElementById('user-info'),
      userEmail: document.getElementById('user-email'),
      orderFormSection: document.getElementById('order-form-section'),
      orderListSection: document.getElementById('order-list-section'),
      emailInput: document.getElementById('email'),
      passwordInput: document.getElementById('password'),
      signInBtn: document.getElementById('signInBtn'),
      signUpBtn: document.getElementById('signUpBtn'),
      signOutBtn: document.getElementById('signOutBtn'),
      customerData: document.getElementById('customerData'),
      courier: document.getElementById('courier'),
      shopPhone: document.getElementById('shopPhone'),
      addOrderBtn: document.getElementById('addOrderBtn'),
      ordersContainer: document.getElementById('orders'),
      printSelectedBtn: document.getElementById('printSelectedBtn'),
      printAllBtn: document.getElementById('printAllBtn'),
      syncOrdersBtn: document.getElementById('syncOrdersBtn'),
      syncStatus: document.getElementById('sync-status')
    };

    // Application state
    let orderList = [];
    let isOnline = navigator.onLine;
    let userUid = null;

    // Initialize the app
    function initApp() {
      // Check online status
      window.addEventListener('online', () => {
        isOnline = true;
        updateSyncStatus('‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥');
        syncLocalOrdersToFirebase();
      });
      
      window.addEventListener('offline', () => {
        isOnline = false;
        updateSyncStatus('‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå - ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå');
      });

      // Set up event listeners
      setupEventListeners();

      // Check auth state
      onAuthStateChanged(auth, (user) => {
        if (user) {
          // User is signed in
          userUid = user.uid;
          handleUserSignedIn(user);
        } else {
          // User is signed out
          handleUserSignedOut();
        }
        elements.loading.style.display = 'none';
      });

      // Update initial sync status
      updateSyncStatus(isOnline ? '‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå' : '‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå');
    }

    // Set up event listeners
    function setupEventListeners() {
      // Auth buttons
      elements.signInBtn.addEventListener('click', signIn);
      elements.signUpBtn.addEventListener('click', signUp);
      elements.signOutBtn.addEventListener('click', signOut);

      // Order form
      elements.courier.addEventListener('change', updatePhoneByCourier);
      elements.addOrderBtn.addEventListener('click', addOrder);
      
      // Print buttons
      elements.printSelectedBtn.addEventListener('click', printSelected);
      elements.printAllBtn.addEventListener('click', printAll);
      elements.syncOrdersBtn.addEventListener('click', syncLocalOrdersToFirebase);
    }

    // Auth functions
    async function signUp() {
      const email = elements.emailInput.value.trim();
      const password = elements.passwordInput.value.trim();
      
      if (!email || !password) {
        return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô");
      }

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        
        // Save additional user data to Realtime Database
        await set(ref(db, users/${user.uid}), {
          email: user.email,
          createdAt: new Date().toISOString()
        });
        
        alert("‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      } catch (error) {
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
      }
    }

    async function signIn() {
      const email = elements.emailInput.value.trim();
      const password = elements.passwordInput.value.trim();
      
      if (!email || !password) {
        return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô");
      }

      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (error) {
        alert("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
      }
    }

    async function signOut() {
      try {
        await signOut(auth);
      } catch (error) {
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö: " + error.message);
      }
    }

    // User state handlers
    function handleUserSignedIn(user) {
      elements.authSection.style.display = 'none';
      elements.userInfo.style.display = 'block';
      elements.orderFormSection.style.display = 'block';
      elements.orderListSection.style.display = 'block';
      elements.userEmail.textContent = user.email;
      
      // Load orders from Firebase and local storage
      loadOrders(user.uid);
    }

    function handleUserSignedOut() {
      elements.authSection.style.display = 'block';
      elements.userInfo.style.display = 'none';
      elements.orderFormSection.style.display = 'none';
      elements.orderListSection.style.display = 'none';
      elements.ordersContainer.innerHTML = '';
      orderList = [];
    }

    // Order functions
    function updatePhoneByCourier() {
      const courier = elements.courier.value;
      
      if (courier === 'Anousith Express') {
        elements.shopPhone.value = '020 94036226';
      } else {
        elements.shopPhone.value = '020 98052744';
      }
    }

    async function addOrder() {
      const customer = elements.customerData.value.trim();
      const courier = elements.courier.value;
      const shopPhone = elements.shopPhone.value;
      
      if (!customer) {
        return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤');
      }

      const id = generateId();
      const date = new Date();
      const barcode = Math.floor(100000000000 + Math.random() * 900000000000);
      const order = { 
        id, 
        customer, 
        courier, 
        date: date.toISOString(), 
        barcode, 
        shopPhone,
        localOnly: !isOnline // Mark if created offline
      };

      // Add to local list
      orderList.push(order);
      saveToLocalStorage();
      renderOrders();
      elements.customerData.value = '';

      // Save to Firebase if online
      if (isOnline && userUid) {
        try {
          const ordersRef = ref(db, users/${userUid}/orders);
          const newOrderRef = push(ordersRef);
          await set(newOrderRef, order);
          
          // Update local order with Firebase key
          const index = orderList.findIndex(o => o.id === order.id);
          if (index !== -1) {
            orderList[index].firebaseKey = newOrderRef.key;
            orderList[index].localOnly = false;
            saveToLocalStorage();
            renderOrders();
          }
        } catch (error) {
          console.error("Error saving order to Firebase:", error);
          updateSyncStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
        }
      }
    }

    function generateId() {
      return 'BN' + Math.floor(Math.random() * 100000);
    }

    // Load orders from Firebase and local storage
    function loadOrders(userId) {
      // First load from local storage
      const savedOrders = localStorage.getItem(bnShopOrders_${userId});
      if (savedOrders) {
        orderList = JSON.parse(savedOrders);
        orderList.forEach(order => {
          order.date = new Date(order.date);
        });
        renderOrders();
      }

      // Then sync with Firebase if online
      if (isOnline) {
        syncOrdersFromFirebase(userId);
      }
    }

    // Sync orders from Firebase
    function syncOrdersFromFirebase(userId) {
      updateSyncStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå...');
      
      const ordersRef = ref(db, users/${userId}/orders);
      onValue(ordersRef, (snapshot) => {
        const firebaseOrders = [];
        snapshot.forEach((childSnapshot) => {
          const order = childSnapshot.val();
          order.firebaseKey = childSnapshot.key;
          order.date = new Date(order.date);
          firebaseOrders.push(order);
        });

        // Merge with local orders
        const mergedOrders = mergeOrders(orderList, firebaseOrders);
        orderList = mergedOrders;
        saveToLocalStorage();
        renderOrders();
        
        updateSyncStatus('‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô');
      }, (error) => {
        console.error("Error syncing orders:", error);
        updateSyncStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
      });
    }

    // Sync local orders to Firebase
    async function syncLocalOrdersToFirebase() {
      if (!isOnline || !userUid) {
        updateSyncStatus('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏ì‡∏∞‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå');
        return;
      }

      updateSyncStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå...');
      
      try {
        const ordersToSync = orderList.filter(order => order.localOnly);
        const ordersRef = ref(db, users/${userUid}/orders);
        
        for (const order of ordersToSync) {
          const newOrderRef = push(ordersRef);
          await set(newOrderRef, {
            id: order.id,
            customer: order.customer,
            courier: order.courier,
            date: order.date.toISOString(),
            barcode: order.barcode,
            shopPhone: order.shopPhone
          });
          
          // Update local order with Firebase key
          const index = orderList.findIndex(o => o.id === order.id);
          if (index !== -1) {
            orderList[index].firebaseKey = newOrderRef.key;
            orderList[index].localOnly = false;
          }
        }
        saveToLocalStorage();
        renderOrders();
        updateSyncStatus('‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô');
      } catch (error) {
        console.error("Error syncing orders:", error);
        updateSyncStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
      }
    }

    // Merge local and Firebase orders
    function mergeOrders(localOrders, firebaseOrders) {
      const merged = [...firebaseOrders];
      
      // Add local orders that don't exist in Firebase
      localOrders.forEach(localOrder => {
        if (!localOrder.firebaseKey && 
            !merged.some(fbOrder => fbOrder.id === localOrder.id)) {
          merged.push(localOrder);
        }
      });
      
      return merged;
    }

    // Save to local storage
    function saveToLocalStorage() {
      if (userUid) {
        localStorage.setItem(`bnShopOrders_${userUid}`, JSON.stringify(orderList));
      }
    }

    // Render orders
    function renderOrders() {
      elements.ordersContainer.innerHTML = '';
      
      // Sort by date (newest first)
      const sortedOrders = [...orderList].sort((a, b) => b.date - a.date);
      
      sortedOrders.forEach((order, index) => {
        const div = document.createElement('div');
        div.className = 'order';
        
        const localOnlyBadge = order.localOnly ? 
          '<span style="color:red; font-size:12px;"> (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå)</span>' : '';
        
        div.innerHTML = `
          <input type="checkbox" data-index="${index}" checked>
          <strong>Order ID:</strong> ${order.id}${localOnlyBadge}<br>
          <strong>‡∏Ç‡∏ô‡∏™‡πà‡∏á:</strong> ${order.courier}<br>
          <strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡πâ‡∏≤‡∏ô:</strong> ${order.shopPhone}<br>
          <strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${order.date.toLocaleString()}<br>
          <strong>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</strong><br> <pre class="customer-pre">${order.customer}</pre>
          <button class="btn btn-danger" data-index="${index}">‡∏•‡∏ö</button>
          <button class="btn" data-index="${index}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        `;
        
        // Add event listeners to buttons
        div.querySelector('.btn-danger').addEventListener('click', () => deleteOrder(index));
        div.querySelector('.btn:not(.btn-danger)').addEventListener('click', () => editOrder(index));
        
        elements.ordersContainer.appendChild(div);
      });
    }

    // Delete order
    async function deleteOrder(index) {
      if (!confirm('‡∏•‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?')) return;
      
      const order = orderList[index];
      
      // Delete from Firebase if it exists there
      if (isOnline && order.firebaseKey && userUid) {
        try {
          const orderRef = ref(db, `users/${userUid}/orders/${order.firebaseKey}`);
          await remove(orderRef);
        } catch (error) {
          console.error("Error deleting order from Firebase:", error);
          alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ");
          return;
        }
      }
      
      // Delete from local storage
      orderList.splice(index, 1);
      saveToLocalStorage();
      renderOrders();
    }

    // Edit order
    async function editOrder(index) {
      const order = orderList[index];
      const updated = prompt('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:', order.customer);
      
      if (updated === null) return;
      
      const updatedCustomer = updated.trim();
      if (updatedCustomer === order.customer) return;
      
      // Update local order
      orderList[index].customer = updatedCustomer;
      saveToLocalStorage();
      renderOrders();
      
      // Update in Firebase if online
      if (isOnline && order.firebaseKey && userUid) {
        try {
          const orderRef = ref(db, `users/${userUid}/orders/${order.firebaseKey}`);
          await update(orderRef, { customer: updatedCustomer });
        } catch (error) {
          console.error("Error updating order in Firebase:", error);
          alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏ô‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ");
        }
      }
    }

    // Print functions
    function generateBarcodeSVG(barcodeNumber) {
      const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      JsBarcode(svg, barcodeNumber.toString(), {
        format: "CODE128",
        lineColor: "#000",
        width: 2,
        height: 50,
        displayValue: false
      });
      return svg.outerHTML;
    }

    function printBill(order) {
      const dateStr = order.date.toLocaleString();
      const barcodeSVG = generateBarcodeSVG(order.barcode);
      
      return `
        <div class="bill">
          <div class="header">
            <div class="logo">BN</div>
            <div class="shop-info">
              ‡∫Æ‡ªâ‡∫≤‡∫ô : BN Shop<br>
              ‡ªÄ‡∫ö‡∫µ‡ªÇ‡∫ó : ${order.shopPhone}
            </div>
          </div>
          <div class="section">
            <div><strong>‡∫ß‡∫±‡∫ô‡∫ó‡∫µ:</strong> ${dateStr}</div>
            <div><strong>‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫≠‡∫≠‡ªÄ‡∫î‡∫µ:</strong> ${order.id}</div>
          </div>
          <div class="barcode-container">
            ${barcodeSVG}
            <div class="barcode-number">${order.barcode}</div>
          </div>
          <div class="section">
            <div><strong>‡∫Ç‡∫ª‡∫ô‡∫™‡∫ª‡ªà‡∫á:</strong> ${order.courier}</div>
            <div><strong>‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤:</strong><br><pre>${order.customer.replace(/\n/g, '<br>')}</pre></div>
          </div>
          <div class="thankyou">‡∫Ç‡ªç‡∫Ç‡∫≠‡∫ö‡ªÉ‡∫àüíó</div>
        </div>
      `;
    }

    function printSelected() {
      const checkboxes = document.querySelectorAll('#orders input[type=checkbox]');
      const selectedOrders = Array.from(checkboxes)
                               .filter(c => c.checked)
                               .map(c => orderList[c.dataset.index]);
      
      if (selectedOrders.length === 0) {
        return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå');
      }
      
      printBills(selectedOrders);
    }

    function printAll() {
      if (orderList.length === 0) {
        return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå');
      }
      
      printBills(orderList);
    }

    function printBills(orders) {
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html>
          <head>
            <title>Print Bills</title>
            <style>
              body { margin: 0; padding: 0; }
              @page { size: 80mm 150mm; margin: 0; }
              .bill { 
                width: 76mm; 
                height: auto; 
                min-height: 130mm; 
                padding: 10px; 
                font-size: 14px; 
                box-sizing: border-box; 
                border: 1px solid #000; 
                margin: 0 auto 10mm; 
                page-break-after: always; 
                font-family: 'Noto Sans Lao', sans-serif; 
                overflow: hidden;
              }
              .logo { font-size: 48px; font-weight: bold; display: inline-block; vertical-align: middle; margin-right: 10px; }
              .shop-info { display: inline-block; vertical-align: middle; line-height: 1.4; white-space: nowrap; }
              .header { margin-bottom: 10px; }
              .section { margin-top: 10px; }
              .barcode-container { text-align: center; margin: 15px 0; }
              .barcode-number { text-align: center; font-family: monospace; font-size: 12px; margin-top: 5px; }
              .thankyou { text-align: center; margin-top: 20px; font-weight: bold; }
              pre {
                white-space: pre-wrap;
                word-wrap: break-word;
                margin: 0;
                line-height: 1.4;
              }
            </style>
          </head>
          <body>
      `);
      
      orders.forEach(order => {
        printWindow.document.write(printBill(order));
      });
      
      printWindow.document.write(`
          </body>
        </html>
      `);
      
      printWindow.document.close();
      setTimeout(() => {
        printWindow.print();
      }, 500);
    }

    // Update sync status
    function updateSyncStatus(message) {
      elements.syncStatus.textContent = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${message}`;
      
      if (message.includes('‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå')) {
        elements.syncStatus.style.backgroundColor = '#d4edda';
        elements.syncStatus.style.color = '#155724';
      } else if (message.includes('‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå')) {
        elements.syncStatus.style.backgroundColor = '#fff3cd';
        elements.syncStatus.style.color = '#856404';
      } else if (message.includes('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î')) {
        elements.syncStatus.style.backgroundColor = '#f8d7da';
        elements.syncStatus.style.color = '#721c24';
      } else {
        elements.syncStatus.style.backgroundColor = '#cce5ff';
        elements.syncStatus.style.color = '#004085';
      }
    }

    // Initialize the application
    initApp();
  </script>
</body>
</html>
