<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BN POS System - Ultimate SaaS Edition</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #F8FAFC; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .animate-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            #receipt-content, #receipt-content * { visibility: visible; }
            #receipt-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
                background: white;
                color: black;
            }
            .print\:hidden { display: none !important; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- ICONS (SVG Elements wrapped in <g> for stability) ---
        const Icon = ({ children, size=24, className="", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                {children}
            </svg>
        );

        const icons = {
            store: <path d="m2 7 4.41-4.41A2 2 0 0 1 7.83 2h8.34a2 2 0 0 1 1.42.59L22 7M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8M15 22v-4a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v4M2 7h20M22 7v3a2 2 0 0 1-2 2v0a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 16 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 12 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 8 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 4 12v0a2 2 0 0 1-2-2V7"/>,
            home: <g><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></g>,
            history: <g><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></g>,
            package: <g><path d="m16.5 9.4-9-5.19"/><path d="m21 16-9 5.19-9-5.19"/><path d="m3.29 7 9-5.19 9 5.19"/><line x1="12" y1="2" x2="12" y2="22"/><path d="m12 22 9-5.19V7l-9 5.19-9-5.19v9.81Z"/></g>,
            dashboard: <g><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></g>,
            settings: <g><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.35a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></g>,
            logout: <g><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></g>,
            shield: <g><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="m9 12 2 2 4-4"/></g>,
            user: <g><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></g>,
            search: <g><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></g>,
            plus: <g><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></g>,
            minus: <line x1="5" y1="12" x2="19" y2="12"/>,
            trash: <g><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></g>,
            pause: <g><circle cx="12" cy="12" r="10"/><line x1="10" y1="15" x2="10" y2="9"/><line x1="14" y1="15" x2="14" y2="9"/></g>,
            play: <g><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></g>,
            scan: <g><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/></g>,
            alert: <g><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></g>,
            trending: <g><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></g>,
            banknote: <g><rect width="20" height="12" x="2" y="6" rx="2"/><circle cx="12" cy="12" r="2"/><path d="M6 12h.01M18 12h.01"/></g>,
            upload: <g><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></g>,
            x: <g><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></g>,
            check: <g><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></g>,
            calendar: <g><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></g>,
            userCheck: <g><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><polyline points="16 11 18 13 22 9"/></g>,
            userX: <g><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="17" y1="8" x2="22" y2="13"/><line x1="22" y1="8" x2="17" y2="13"/></g>,
            coffee: <g><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></g>,
            edit: <g><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></g>,
            receipt: <g><path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2 1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1Z"/><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"/><path d="M12 17V7"/></g>,
            shoppingCart: <g><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></g>,
            arrowUpRight: <g><path d="M7 7h10v10"/><path d="M7 17 17 7"/></g>,
            printer: <g><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></g>
        };

        const Lucide = ({ name, size=24, className="" }) => (
            <Icon size={size} className={className}>{icons[name] || icons.store}</Icon>
        );

        // --- CONSTANTS & HELPERS ---
        const MASTER_ADMIN = { email: 'bnathhomsombath@gmail.com', password: 'Asdf123#' };
        const formatCurrency = (val) => new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB' }).format(val);
        
        const INITIAL_PRODUCTS = [
            { id: 101, barcode: '885101', name: 'Sig. Americano', price: 65, cost: 25, category: 'Coffee', stock: 50, image: '‚òï', color: 'from-amber-900 to-amber-700 text-amber-50' },
            { id: 102, barcode: '885102', name: 'Caramel Macchiato', price: 85, cost: 35, category: 'Coffee', stock: 40, image: 'ü•õ', color: 'from-amber-800 to-amber-600 text-amber-50' },
            { id: 103, barcode: '885103', name: 'Premium Matcha', price: 90, cost: 40, category: 'Tea', stock: 25, image: 'üçµ', color: 'from-green-800 to-green-600 text-green-50' },
            { id: 201, barcode: '885201', name: 'Butter Croissant', price: 65, cost: 30, category: 'Bakery', stock: 12, image: 'ü•ê', color: 'from-yellow-600 to-yellow-400 text-yellow-50' },
            { id: 301, barcode: '885301', name: 'Mineral Water', price: 15, cost: 5, category: 'Mart', stock: 100, image: 'üíß', color: 'from-blue-500 to-blue-300 text-blue-50' }
        ];

        const CATEGORIES = [
            { id: 'All', name: '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', icon: 'store' },
            { id: 'Coffee', name: '‡∏Å‡∏≤‡πÅ‡∏ü', icon: 'coffee' },
            { id: 'Tea', name: '‡∏ä‡∏≤', icon: 'store' },
            { id: 'Bakery', name: '‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà', icon: 'store' },
            { id: 'Mart', name: '‡∏°‡∏¥‡∏ô‡∏¥‡∏°‡∏≤‡∏£‡πå‡∏ó', icon: 'package' },
        ];

        // --- COMPONENTS ---

        const ImageUploader = ({ label, currentImage, onImageChange }) => {
            const inputRef = useRef(null);
            const handleFile = (e) => {
                const file = e.target.files[0];
                if(file){
                    if(file.size > 500000) return alert("File too large (Max 500KB)");
                    const reader = new FileReader();
                    reader.onloadend = () => onImageChange(reader.result);
                    reader.readAsDataURL(file);
                }
            };
            return (
                <div className="space-y-2">
                    <label className="block text-sm font-bold text-slate-600">{label}</label>
                    <div onClick={() => inputRef.current.click()} className="h-32 border-2 border-dashed border-slate-300 rounded-2xl flex flex-col items-center justify-center cursor-pointer hover:bg-slate-50 hover:border-blue-500 transition-all overflow-hidden relative">
                        {currentImage ? 
                            <img src={currentImage} className="w-full h-full object-contain" /> :
                            <div className="text-center text-slate-400"><Lucide name="upload" className="mx-auto mb-1"/><span className="text-xs">Upload</span></div>
                        }
                        <input type="file" ref={inputRef} className="hidden" accept="image/*" onChange={handleFile}/>
                    </div>
                </div>
            );
        };

        const AuthScreen = ({ onLogin }) => {
            const [isLogin, setIsLogin] = useState(true);
            const [form, setForm] = useState({email:'', password:'', shopName:'', confirm:''});
            const [err, setErr] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                setErr('');
                
                // Master Admin Check
                if(isLogin && form.email === MASTER_ADMIN.email && form.password === MASTER_ADMIN.password) {
                    onLogin({ role: 'admin', email: form.email, shopName: 'Master Admin Shop', status: 'active', expiryDate: '9999-12-31' });
                    return;
                }

                const db = JSON.parse(localStorage.getItem('bn_pos_users') || '[]');
                
                if(isLogin) {
                    const user = db.find(u => u.email === form.email && u.password === form.password);
                    if(user) onLogin({...user, role:'user'});
                    else setErr('‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                } else {
                    if(form.password !== form.confirm) return setErr('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô');
                    if(db.find(u => u.email === form.email)) return setErr('‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß');
                    if(!form.shopName) return setErr('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô');
                    
                    const newUser = { 
                        email: form.email, password: form.password, shopName: form.shopName, 
                        status: 'pending', expiryDate: null, joinedAt: new Date().toISOString() 
                    };
                    db.push(newUser);
                    localStorage.setItem('bn_pos_users', JSON.stringify(db));
                    onLogin({...newUser, role:'user'});
                }
            };

            return (
                <div className="fixed inset-0 bg-slate-900 flex items-center justify-center p-4">
                    <div className="bg-white/10 backdrop-blur-md border border-white/20 p-8 rounded-3xl w-full max-w-md text-white shadow-2xl">
                        <div className="text-center mb-6">
                            <div className="w-16 h-16 bg-gradient-to-tr from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                                <Lucide name="store" size={32} className="text-white"/>
                            </div>
                            <h1 className="text-2xl font-bold">BN POS SaaS</h1>
                            <p className="text-slate-300 text-sm">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏£‡∏ö‡∏ß‡∏á‡∏à‡∏£</p>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            {!isLogin && <input className="w-full p-3 rounded-xl bg-white/10 border border-white/20 placeholder-slate-400 focus:outline-none focus:border-blue-500 text-white" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤" value={form.shopName} onChange={e=>setForm({...form, shopName:e.target.value})} required />}
                            <input type="email" className="w-full p-3 rounded-xl bg-white/10 border border-white/20 placeholder-slate-400 focus:outline-none focus:border-blue-500 text-white" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" value={form.email} onChange={e=>setForm({...form, email:e.target.value})} required />
                            <input type="password" className="w-full p-3 rounded-xl bg-white/10 border border-white/20 placeholder-slate-400 focus:outline-none focus:border-blue-500 text-white" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" value={form.password} onChange={e=>setForm({...form, password:e.target.value})} required />
                            {!isLogin && <input type="password" className="w-full p-3 rounded-xl bg-white/10 border border-white/20 placeholder-slate-400 focus:outline-none focus:border-blue-500 text-white" placeholder="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" value={form.confirm} onChange={e=>setForm({...form, confirm:e.target.value})} required />}
                            
                            {err && <div className="p-3 bg-red-500/20 text-red-200 text-sm rounded-xl flex gap-2"><Lucide name="alert"/> {err}</div>}
                            
                            <button className="w-full py-3 bg-blue-600 hover:bg-blue-700 rounded-xl font-bold transition-all shadow-lg">
                                {isLogin ? '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö' : '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å'}
                            </button>
                        </form>
                        <button onClick={()=>{setIsLogin(!isLogin); setErr('')}} className="w-full mt-4 text-sm text-slate-400 hover:text-white">
                            {isLogin ? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å' : '‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'}
                        </button>
                    </div>
                </div>
            );
        };

        const SubWall = ({ user, onLogout }) => (
            <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4">
                <div className="bg-white p-8 rounded-3xl shadow-xl max-w-md w-full text-center">
                    <div className="w-20 h-20 bg-orange-100 text-orange-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <Lucide name={user.status==='pending' ? 'history' : 'shield'} size={40}/>
                    </div>
                    <h2 className="text-2xl font-bold text-slate-800 mb-2">{user.status==='pending' ? '‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' : '‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö/‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏'}</h2>
                    <p className="text-slate-500 mb-6">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô<br/>Email: {MASTER_ADMIN.email}</p>
                    <button onClick={onLogout} className="w-full py-3 bg-slate-200 hover:bg-slate-300 rounded-xl font-bold text-slate-600">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>
            </div>
        );

        const AdminPanel = () => {
            const [users, setUsers] = useState(() => JSON.parse(localStorage.getItem('bn_pos_users') || '[]'));
            
            const updateStatus = (email, status, days=0) => {
                const updated = users.map(u => {
                    if(u.email !== email) return u;
                    let exp = u.expiryDate ? new Date(u.expiryDate) : new Date();
                    if(days > 0) {
                        if(exp < new Date()) exp = new Date();
                        exp.setDate(exp.getDate() + days);
                    }
                    return { ...u, status, expiryDate: status === 'active' ? exp.toISOString() : u.expiryDate };
                });
                setUsers(updated);
                localStorage.setItem('bn_pos_users', JSON.stringify(updated));
            };

            const delUser = (email) => {
                if(confirm('‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ?')) {
                    const updated = users.filter(u => u.email !== email);
                    setUsers(updated);
                    localStorage.setItem('bn_pos_users', JSON.stringify(updated));
                }
            };

            return (
                <div className="p-8 h-full overflow-y-auto">
                    <h2 className="text-3xl font-black text-slate-800 mb-6 flex items-center gap-2">
                        <Lucide name="shield" className="text-blue-600"/> Master Admin Panel
                    </h2>
                    <div className="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                        <table className="w-full text-left">
                            <thead className="bg-slate-50 text-slate-500 font-bold uppercase text-sm">
                                <tr>
                                    <th className="p-4">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                    <th className="p-4">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th className="p-4">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</th>
                                    <th className="p-4 text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {users.map(u => (
                                    <tr key={u.email} className="hover:bg-slate-50">
                                        <td className="p-4">
                                            <div className="font-bold text-slate-800">{u.shopName}</div>
                                            <div className="text-xs text-slate-500">{u.email}</div>
                                        </td>
                                        <td className="p-4">
                                            <span className={`px-2 py-1 rounded text-xs font-bold uppercase ${u.status==='active'?'bg-green-100 text-green-700': u.status==='pending'?'bg-orange-100 text-orange-700':'bg-red-100 text-red-700'}`}>
                                                {u.status}
                                            </span>
                                        </td>
                                        <td className="p-4 text-sm text-slate-500">
                                            {u.expiryDate ? new Date(u.expiryDate).toLocaleDateString() : '-'}
                                        </td>
                                        <td className="p-4 flex justify-center gap-2">
                                            <button onClick={()=>updateStatus(u.email,'active',30)} className="p-2 bg-blue-100 text-blue-600 rounded hover:bg-blue-200" title="+30 Days"><Lucide name="calendar" size={16}/></button>
                                            <button onClick={()=>updateStatus(u.email,'active',365)} className="p-2 bg-purple-100 text-purple-600 rounded hover:bg-purple-200" title="+1 Year"><Lucide name="trending" size={16}/></button>
                                            <button onClick={()=>updateStatus(u.email,'suspended')} className="p-2 bg-orange-100 text-orange-600 rounded hover:bg-orange-200" title="Suspend"><Lucide name="userX" size={16}/></button>
                                            <button onClick={()=>delUser(u.email)} className="p-2 bg-red-100 text-red-600 rounded hover:bg-red-200"><Lucide name="trash" size={16}/></button>
                                        </td>
                                    </tr>
                                ))}
                                {users.length === 0 && <tr><td colSpan="4" className="p-8 text-center text-slate-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</td></tr>}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const DashboardPanel = ({ history, products }) => {
            const sales = history.filter(h => h.status === 'completed');
            const totalSales = sales.reduce((sum, order) => sum + order.total, 0);
            
            const totalCost = sales.reduce((sum, order) => {
                const cost = order.items.reduce((c, i) => c + (i.cost || 0) * i.qty, 0);
                return sum + cost;
            }, 0);
            const profit = totalSales - totalCost;

            // Simple HTML Chart
            const last10 = sales.slice(0, 10).reverse();
            const maxVal = Math.max(...last10.map(s=>s.total), 100);

            return (
                <div className="p-8 h-full overflow-y-auto">
                    <h2 className="text-3xl font-black text-slate-800 mb-6">Dashboard</h2>
                    <div className="grid grid-cols-3 gap-6 mb-8">
                        <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                            <div className="text-slate-500 text-sm font-bold uppercase mb-2 flex items-center gap-2"><Lucide name="banknote"/> Total Sales</div>
                            <div className="text-4xl font-black text-slate-800">{formatCurrency(totalSales)}</div>
                        </div>
                        <div className="bg-gradient-to-br from-indigo-600 to-purple-700 p-6 rounded-3xl shadow-lg text-white">
                            <div className="text-indigo-200 text-sm font-bold uppercase mb-2 flex items-center gap-2"><Lucide name="trending"/> Net Profit</div>
                            <div className="text-4xl font-black">{formatCurrency(profit)}</div>
                        </div>
                        <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                            <div className="text-slate-500 text-sm font-bold uppercase mb-2 flex items-center gap-2"><Lucide name="alert"/> Low Stock</div>
                            <div className="text-4xl font-black text-orange-500">{products.filter(p=>p.stock<10).length} Items</div>
                        </div>
                    </div>
                    
                    <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 h-80 mb-8 flex flex-col">
                        <h3 className="font-bold mb-4 text-slate-700">Recent Sales Trend</h3>
                        <div className="flex-1 flex items-end justify-between gap-2 px-2">
                            {last10.length === 0 ? <p className="w-full text-center text-slate-400 my-auto">No sales data yet</p> : 
                             last10.map((s,i) => (
                                <div key={i} className="flex-1 flex flex-col items-center group relative">
                                    <div className="w-full bg-blue-500 rounded-t-lg transition-all duration-500 hover:bg-blue-600" style={{height: `${(s.total/maxVal)*100}%`, minHeight:'4px'}}></div>
                                    <div className="text-[10px] text-slate-400 mt-2 truncate w-full text-center">#{s.id.split('-')[1]}</div>
                                    <div className="absolute -top-8 bg-slate-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">
                                        {formatCurrency(s.total)}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const InventoryPanel = ({ products, onUpdate, onAdd, onDelete }) => {
            const [isAdd, setIsAdd] = useState(false);
            const [form, setForm] = useState({});
            const [search, setSearch] = useState('');

            useEffect(() => {
                let buffer = '';
                let lastTime = 0;
                const onKey = (e) => {
                    const now = Date.now();
                    if (now - lastTime > 100) buffer = '';
                    lastTime = now;
                    if (e.key === 'Enter') {
                        if (buffer.length > 2) setSearch(buffer);
                        buffer = '';
                    } else if (e.key.length === 1) buffer += e.key;
                };
                window.addEventListener('keydown', onKey);
                return () => window.removeEventListener('keydown', onKey);
            }, []);

            const filtered = products.filter(p => p.name.toLowerCase().includes(search.toLowerCase()) || (p.barcode && p.barcode.includes(search)));

            return (
                <div className="p-8 h-full flex flex-col">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-3xl font-black text-slate-800">Inventory</h2>
                        <div className="flex gap-3">
                            <div className="relative">
                                <Lucide name="search" className="absolute left-3 top-3 text-slate-400" size={18}/>
                                <input className="pl-10 pr-4 py-2 border rounded-xl w-64 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Search / Scan..." value={search} onChange={e=>setSearch(e.target.value)}/>
                            </div>
                            <button onClick={()=>{setIsAdd(true); setForm({category:'Mart'})}} className="px-4 py-2 bg-blue-600 text-white rounded-xl font-bold flex items-center gap-2 hover:bg-blue-700 shadow-lg"><Lucide name="plus"/> Add New</button>
                        </div>
                    </div>

                    {isAdd && (
                        <div className="mb-6 p-6 bg-white rounded-3xl shadow-lg border border-blue-100 animate-in">
                            <h3 className="font-bold mb-4">Add Product</h3>
                            <div className="grid grid-cols-6 gap-4">
                                <div className="col-span-2"><label className="text-xs font-bold text-slate-500">Barcode</label><input className="w-full p-2 border rounded-lg" value={form.barcode||''} onChange={e=>setForm({...form, barcode:e.target.value})} autoFocus/></div>
                                <div className="col-span-2"><label className="text-xs font-bold text-slate-500">Name</label><input className="w-full p-2 border rounded-lg" value={form.name||''} onChange={e=>setForm({...form, name:e.target.value})}/></div>
                                <div className="col-span-1"><label className="text-xs font-bold text-slate-500">Category</label><select className="w-full p-2 border rounded-lg" value={form.category||'Mart'} onChange={e=>setForm({...form, category:e.target.value})}>{CATEGORIES.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}</select></div>
                                <div className="col-span-1"><label className="text-xs font-bold text-slate-500">Stock</label><input type="number" className="w-full p-2 border rounded-lg" value={form.stock||0} onChange={e=>setForm({...form, stock:parseInt(e.target.value)})}/></div>
                                <div className="col-span-1"><label className="text-xs font-bold text-slate-500">Cost</label><input type="number" className="w-full p-2 border rounded-lg" value={form.cost||0} onChange={e=>setForm({...form, cost:parseFloat(e.target.value)})}/></div>
                                <div className="col-span-1"><label className="text-xs font-bold text-slate-500">Price</label><input type="number" className="w-full p-2 border rounded-lg" value={form.price||0} onChange={e=>setForm({...form, price:parseFloat(e.target.value)})}/></div>
                            </div>
                            <div className="flex justify-end gap-2 mt-4">
                                <button onClick={()=>setIsAdd(false)} className="px-4 py-2 text-slate-500">Cancel</button>
                                <button onClick={()=>{ onAdd({...form, id: Date.now(), image:'üì¶', color:'from-slate-200 to-slate-100'}); setIsAdd(false); setForm({}); }} className="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold">Save</button>
                            </div>
                        </div>
                    )}

                    <div className="bg-white rounded-3xl shadow-sm border border-slate-200 flex-1 overflow-auto">
                        <table className="w-full text-left">
                            <thead className="bg-slate-50 text-slate-500 font-bold text-sm sticky top-0">
                                <tr><th className="p-4">Product</th><th className="p-4">Cost</th><th className="p-4">Price</th><th className="p-4 text-center">Stock</th><th className="p-4 text-center">Action</th></tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {filtered.map(p => (
                                    <tr key={p.id} className="hover:bg-slate-50">
                                        <td className="p-4">
                                            <div className="font-bold text-slate-800">{p.name}</div>
                                            <div className="text-xs text-slate-400 font-mono">{p.barcode || '-'}</div>
                                        </td>
                                        <td className="p-4 text-slate-500">{formatCurrency(p.cost || 0)}</td>
                                        <td className="p-4 font-bold text-slate-800">{formatCurrency(p.price)}</td>
                                        <td className="p-4 text-center"><span className={`px-2 py-1 rounded text-xs font-bold ${p.stock<10 ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`}>{p.stock}</span></td>
                                        <td className="p-4 flex justify-center gap-2">
                                            <button onClick={()=>onDelete(p.id)} className="p-2 text-slate-400 hover:text-red-500 rounded bg-slate-100"><Lucide name="trash" size={16}/></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [currentUser, setCurrentUser] = useState(null);
            const [activeTab, setActiveTab] = useState('pos');
            
            // --- DATA LOAD/SAVE ---
            const [products, setProducts] = useState(() => JSON.parse(localStorage.getItem(`bn_pos_${currentUser?.email}_products`) || JSON.stringify(INITIAL_PRODUCTS)));
            const [history, setHistory] = useState(() => JSON.parse(localStorage.getItem(`bn_pos_${currentUser?.email}_history`) || '[]'));
            const [settings, setSettings] = useState(() => JSON.parse(localStorage.getItem(`bn_pos_${currentUser?.email}_settings`) || JSON.stringify({ shopName: currentUser?.shopName || 'My Shop', logo: '', address: '', phone: '', promptPayQr: '' })));
            const [heldOrders, setHeldOrders] = useState(() => JSON.parse(localStorage.getItem(`bn_pos_${currentUser?.email}_held`) || '[]'));

            useEffect(() => { 
                if(!currentUser) return;
                const prefix = `bn_pos_${currentUser.email}`;
                localStorage.setItem(`${prefix}_products`, JSON.stringify(products));
                localStorage.setItem(`${prefix}_history`, JSON.stringify(history));
                localStorage.setItem(`${prefix}_settings`, JSON.stringify(settings));
                localStorage.setItem(`${prefix}_held`, JSON.stringify(heldOrders));
            }, [products, history, settings, heldOrders, currentUser]);

            // --- POS STATE ---
            const [cart, setCart] = useState([]);
            const [member, setMember] = useState(null);
            const [showPay, setShowPay] = useState(false);
            const [lastOrder, setLastOrder] = useState(null);
            const [search, setSearch] = useState('');
            const [activeCat, setActiveCat] = useState('All');
            const [showHeld, setShowHeld] = useState(false);

            // --- BARCODE SCANNER (POS) ---
            useEffect(() => {
                if(activeTab !== 'pos' || showPay) return;
                let buffer = '';
                let lastTime = 0;
                const onKey = (e) => {
                    const now = Date.now();
                    if (now - lastTime > 100) buffer = '';
                    lastTime = now;
                    if (e.key === 'Enter') {
                        if (buffer.length > 2) {
                            const p = products.find(prod => prod.barcode === buffer);
                            if(p) addToCart(p);
                            buffer = '';
                        }
                    } else if (e.key.length === 1) buffer += e.key;
                };
                window.addEventListener('keydown', onKey);
                return () => window.removeEventListener('keydown', onKey);
            }, [activeTab, showPay, products]);

            const addToCart = (p) => {
                if(p.stock <= 0) return alert("Out of Stock");
                setCart(prev => {
                    const ex = prev.find(i => i.id === p.id);
                    if(ex) {
                        if(ex.qty >= p.stock) return prev;
                        return prev.map(i => i.id === p.id ? {...i, qty: i.qty+1} : i);
                    }
                    return [...prev, {...p, qty: 1}];
                });
            };

            const updateQty = (id, d) => setCart(prev => prev.map(i => i.id === id ? {...i, qty: Math.max(1, i.qty+d)} : i));
            
            const subtotal = cart.reduce((a,c)=>a+c.price*c.qty, 0);
            const discount = member ? subtotal * 0.05 : 0;
            const total = subtotal - discount;

            const handlePay = (method) => {
                const order = {
                    id: `#BN-${Math.floor(Math.random()*100000)}`,
                    date: new Date().toLocaleString('th-TH'),
                    items: cart.map(c => ({...c, cost: c.cost || 0})), // Snapshot cost
                    subtotal, discount, total, method, status: 'completed'
                };
                setHistory([order, ...history]);
                setProducts(prev => prev.map(p => {
                    const inCart = cart.find(c => c.id === p.id);
                    return inCart ? { ...p, stock: p.stock - inCart.qty } : p;
                }));
                setLastOrder(order);
                setCart([]);
                setShowPay(false);
                setMember(null);
            };

            const holdOrder = () => {
                setHeldOrders([...heldOrders, { id: Date.now(), items: cart, time: new Date().toLocaleTimeString() }]);
                setCart([]);
            };

            const recallOrder = (h) => {
                if(cart.length > 0 && !confirm("Replace current cart?")) return;
                setCart(h.items);
                setHeldOrders(heldOrders.filter(o => o.id !== h.id));
                setShowHeld(false);
            };

            const ProductCard = ({ product, onAdd, currentStock }) => {
                const isOutOfStock = currentStock <= 0;
                return (
                    <div onClick={() => !isOutOfStock && onAdd(product)} className={`relative bg-white rounded-3xl p-4 shadow-sm border border-slate-100 transition-all duration-300 group flex flex-col h-full overflow-hidden cursor-pointer hover:shadow-xl hover:-translate-y-1 ${isOutOfStock ? 'opacity-60 grayscale' : ''}`}>
                        {isOutOfStock && <div className="absolute inset-0 z-20 flex items-center justify-center bg-white/60 backdrop-blur-sm"><span className="bg-red-500 text-white text-xs font-bold px-4 py-2 rounded-full shadow-lg">Sold Out</span></div>}
                        <div className={`h-32 rounded-2xl flex items-center justify-center text-5xl mb-4 shadow-inner bg-gradient-to-br ${product.color}`}>{product.image}</div>
                        <div className="mt-auto">
                            <h3 className="font-bold text-slate-800 truncate">{product.name}</h3>
                            <div className="flex justify-between items-center text-xs text-slate-500 mt-1"><span>{product.category}</span><span>Stock: {currentStock}</span></div>
                            <div className="pt-2 text-xl font-black text-slate-800">{formatCurrency(product.price)}</div>
                        </div>
                    </div>
                );
            };

            if (!currentUser) return <AuthScreen onLogin={(u) => { setCurrentUser(u); setProducts(JSON.parse(localStorage.getItem(`bn_pos_${u.email}_products`) || JSON.stringify(INITIAL_PRODUCTS))); }} />;
            
            const isExpired = currentUser.expiryDate && new Date(currentUser.expiryDate) < new Date();
            if (currentUser.role !== 'admin' && (currentUser.status !== 'active' || isExpired)) {
                return <SubWall user={currentUser} onLogout={()=>setCurrentUser(null)} />;
            }

            return (
                <div className="flex h-screen overflow-hidden">
                    {/* Sidebar */}
                    <div className="w-24 bg-white/80 backdrop-blur-xl border-r border-slate-200 flex flex-col items-center py-6 z-30 shrink-0 no-print">
                        <div className="w-14 h-14 rounded-2xl overflow-hidden mb-6 bg-slate-100 shadow-md">
                            {settings.logo ? <img src={settings.logo} className="w-full h-full object-cover"/> : <div className="w-full h-full flex items-center justify-center text-blue-600 font-bold">BN</div>}
                        </div>
                        <nav className="flex-1 flex flex-col gap-4 w-full px-2">
                            {[
                                { id: 'pos', icon: 'home', label: '‡∏Ç‡∏≤‡∏¢' },
                                { id: 'orders', icon: 'history', label: '‡∏ö‡∏¥‡∏•' },
                                { id: 'inventory', icon: 'package', label: '‡∏™‡∏ï‡πá‡∏≠‡∏Å' },
                                { id: 'dashboard', icon: 'dashboard', label: '‡∏™‡∏£‡∏∏‡∏õ' },
                                { id: 'settings', icon: 'settings', label: '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤' }
                            ].map(item => (
                                <button key={item.id} onClick={()=>setActiveTab(item.id)} className={`p-3 rounded-2xl flex flex-col items-center transition-all ${activeTab===item.id ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-100'}`}>
                                    <Lucide name={item.icon}/>
                                    <span className="text-[10px] mt-1 font-bold">{item.label}</span>
                                </button>
                            ))}
                            {currentUser.role === 'admin' && (
                                <button onClick={()=>setActiveTab('admin')} className={`p-3 rounded-2xl flex flex-col items-center transition-all ${activeTab==='admin' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-100'}`}>
                                    <Lucide name="shield"/>
                                    <span className="text-[10px] mt-1 font-bold">Admin</span>
                                </button>
                            )}
                        </nav>
                        <button onClick={()=>setCurrentUser(null)} className="p-3 text-slate-400 hover:text-red-500 rounded-2xl"><Lucide name="logout"/></button>
                    </div>

                    {/* Main Content */}
                    <div className="flex-1 flex overflow-hidden relative no-print">
                        {activeTab === 'pos' ? (
                            <>
                                <div className="flex-1 flex flex-col min-w-0 z-10 bg-slate-50/50">
                                    <header className="px-8 py-6 flex justify-between items-center">
                                        <div>
                                            <h1 className="text-3xl font-black text-slate-800 tracking-tight">{settings.shopName}</h1>
                                            <p className="text-slate-400 text-sm">Welcome back, {currentUser.role}</p>
                                        </div>
                                        <div className="flex gap-4">
                                            <div className="relative">
                                                <Lucide name="search" className="absolute left-3 top-3 text-slate-400" size={20}/>
                                                <input className="pl-10 pr-4 py-3 rounded-2xl border-none shadow-sm w-72 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Search product..." value={search} onChange={e=>setSearch(e.target.value)}/>
                                            </div>
                                        </div>
                                    </header>
                                    
                                    <div className="px-8 pb-4 flex gap-3 overflow-x-auto no-scrollbar">
                                        {CATEGORIES.map(c => (
                                            <button key={c.id} onClick={()=>setActiveCat(c.id)} className={`px-6 py-3 rounded-2xl font-bold text-sm shadow-sm transition-all flex items-center gap-2 ${activeCat===c.id ? 'bg-slate-800 text-white scale-105' : 'bg-white text-slate-500 hover:bg-slate-100'}`}>
                                                <Lucide name={c.icon} size={18}/> {c.name}
                                            </button>
                                        ))}
                                    </div>

                                    <div className="flex-1 overflow-y-auto px-8 pb-20">
                                        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                                            {products
                                                .filter(p => (activeCat==='All' || p.category===activeCat) && p.name.toLowerCase().includes(search.toLowerCase()))
                                                .map(p => <ProductCard key={p.id} product={p} onAdd={addToCart} currentStock={p.stock} />)
                                            }
                                        </div>
                                    </div>
                                </div>

                                {/* Cart Sidebar */}
                                <div className="w-[420px] bg-white border-l border-slate-200 flex flex-col shadow-2xl z-20">
                                    <div className="p-6 border-b border-slate-100">
                                        <div className="flex justify-between items-center mb-4">
                                            <h2 className="text-xl font-black text-slate-800 flex items-center gap-2">Current Order <span className="bg-blue-100 text-blue-600 px-2 py-0.5 rounded-lg text-sm">{cart.reduce((a,c)=>a+c.qty,0)}</span></h2>
                                            <div className="flex gap-2">
                                                <button onClick={holdOrder} disabled={cart.length===0} className="p-2 bg-orange-100 text-orange-600 rounded-xl hover:bg-orange-200 disabled:opacity-50"><Lucide name="pause"/></button>
                                                <button onClick={()=>setShowHeld(true)} className="p-2 bg-blue-100 text-blue-600 rounded-xl hover:bg-blue-200 relative">
                                                    <Lucide name="play"/>
                                                    {heldOrders.length > 0 && <span className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white rounded-full text-[10px] flex items-center justify-center font-bold">{heldOrders.length}</span>}
                                                </button>
                                                <button onClick={()=>setCart([])} className="p-2 bg-red-100 text-red-600 rounded-xl hover:bg-red-200"><Lucide name="trash"/></button>
                                            </div>
                                        </div>
                                        <div onClick={()=>setMember(member?null:{name:'VIP Customer'})} className={`p-4 rounded-2xl border-2 border-dashed cursor-pointer flex items-center gap-3 ${member ? 'border-green-500 bg-green-50' : 'border-slate-200 hover:bg-slate-50'}`}>
                                            <div className={`p-2 rounded-full ${member ? 'bg-green-500 text-white' : 'bg-slate-200 text-slate-400'}`}><Lucide name="user"/></div>
                                            <div className="flex-1 font-bold text-slate-700">{member ? member.name : 'Add Member (5% Off)'}</div>
                                            {member && <Lucide name="check" className="text-green-500"/>}
                                        </div>
                                    </div>

                                    <div className="flex-1 overflow-y-auto p-6 space-y-3">
                                        {cart.length === 0 ? 
                                            <div className="h-full flex flex-col items-center justify-center text-slate-300 opacity-60"><Lucide name="shoppingCart" size={48}/><p className="mt-2 font-bold">Cart is Empty</p></div> 
                                            : 
                                            cart.map(i => (
                                                <div key={i.id} className="flex gap-3 bg-slate-50 p-3 rounded-2xl border border-slate-100 animate-in">
                                                    <div className="w-12 h-12 bg-white rounded-xl flex items-center justify-center text-xl shadow-sm">{i.image}</div>
                                                    <div className="flex-1 min-w-0">
                                                        <div className="font-bold text-slate-800 truncate">{i.name}</div>
                                                        <div className="text-blue-600 font-bold">‡∏ø{i.price * i.qty}</div>
                                                    </div>
                                                    <div className="flex items-center gap-2 bg-white rounded-xl px-2 shadow-sm border border-slate-100">
                                                        <button onClick={()=>updateQty(i.id, -1)} className="text-slate-400 hover:text-blue-600"><Lucide name="minus" size={16}/></button>
                                                        <span className="w-6 text-center font-bold text-sm">{i.qty}</span>
                                                        <button onClick={()=>updateQty(i.id, 1)} className="text-slate-400 hover:text-blue-600"><Lucide name="plus" size={16}/></button>
                                                    </div>
                                                </div>
                                            ))
                                        }
                                    </div>

                                    <div className="p-6 bg-white border-t border-slate-100 shadow-[0_-10px_40px_rgba(0,0,0,0.05)] rounded-t-[2rem]">
                                        <div className="space-y-2 mb-4 text-sm font-medium text-slate-500">
                                            <div className="flex justify-between"><span>Subtotal</span><span>{formatCurrency(subtotal)}</span></div>
                                            {member && <div className="flex justify-between text-green-600"><span>Discount (5%)</span><span>-{formatCurrency(discount)}</span></div>}
                                            <div className="flex justify-between text-xl font-black text-slate-800 pt-2 border-t border-dashed"><span>Total</span><span>{formatCurrency(total)}</span></div>
                                        </div>
                                        <button onClick={()=>setShowPay(true)} disabled={cart.length===0} className="w-full py-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-2xl font-bold shadow-xl hover:shadow-2xl hover:-translate-y-1 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                                            Charge <Lucide name="arrowUpRight"/>
                                        </button>
                                    </div>
                                </div>
                            </>
                        ) : activeTab === 'inventory' ? (
                            <InventoryPanel products={products} onUpdate={p=>setProducts(products.map(old=>old.id===p.id?p:old))} onAdd={p=>setProducts([...products,p])} onDelete={id=>setProducts(products.filter(p=>p.id!==id))} />
                        ) : activeTab === 'dashboard' ? (
                            <DashboardPanel history={history} products={products} />
                        ) : activeTab === 'settings' ? (
                            <div className="p-8 h-full bg-slate-50/50">
                                <h2 className="text-3xl font-black text-slate-800 mb-8">Settings</h2>
                                <div className="bg-white p-8 rounded-3xl shadow-sm max-w-2xl border border-slate-100 space-y-6">
                                    <div><label className="font-bold mb-2 block">Shop Name</label><input className="w-full p-3 border rounded-xl" value={settings.shopName} onChange={e=>setSettings({...settings, shopName:e.target.value})}/></div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <ImageUploader label="Shop Logo" currentImage={settings.logo} onImageChange={i=>setSettings({...settings, logo:i})}/>
                                        <ImageUploader label="PromptPay QR" currentImage={settings.promptPayQr} onImageChange={i=>setSettings({...settings, promptPayQr:i})}/>
                                    </div>
                                    <div><label className="font-bold mb-2 block">Address</label><textarea className="w-full p-3 border rounded-xl" value={settings.address} onChange={e=>setSettings({...settings, address:e.target.value})}/></div>
                                    <button onClick={()=>alert('Saved!')} className="px-8 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg">Save Changes</button>
                                </div>
                            </div>
                        ) : activeTab === 'admin' ? (
                            <AdminPanel />
                        ) : (
                            <div className="p-8 h-full bg-slate-50/50">
                                <h2 className="text-3xl font-black text-slate-800 mb-8">History</h2>
                                <div className="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
                                    <table className="w-full text-left">
                                        <thead className="bg-slate-50 text-slate-500 font-bold text-sm"><tr><th className="p-4">Order ID</th><th className="p-4">Date</th><th className="p-4">Total</th><th className="p-4">Payment</th></tr></thead>
                                        <tbody className="divide-y divide-slate-100">{history.map(h=><tr key={h.id} className="hover:bg-slate-50"><td className="p-4 font-bold text-blue-600">{h.id}</td><td className="p-4 text-slate-500">{h.date}</td><td className="p-4 font-black">{formatCurrency(h.total)}</td><td className="p-4"><span className="bg-slate-100 px-2 py-1 rounded text-xs font-bold uppercase">{h.method}</span></td></tr>)}</tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Modals */}
                    {showHeld && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-3xl w-96 shadow-2xl">
                                <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-lg">Held Orders</h3><button onClick={()=>setShowHeld(false)}><Lucide name="x"/></button></div>
                                <div className="space-y-2 max-h-96 overflow-y-auto">
                                    {heldOrders.length===0 && <p className="text-slate-400 text-center py-4">No held orders</p>}
                                    {heldOrders.map(h => (
                                        <div key={h.id} onClick={()=>recallOrder(h)} className="p-3 border rounded-xl hover:bg-blue-50 cursor-pointer flex justify-between items-center">
                                            <div><div className="font-bold">{h.time}</div><div className="text-xs text-slate-500">{h.items.length} items</div></div>
                                            <div className="font-bold text-blue-600">{formatCurrency(h.items.reduce((a,c)=>a+c.price*c.qty,0))}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {showPay && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 animate-in">
                            <div className="bg-white p-8 rounded-[2.5rem] w-full max-w-lg shadow-2xl">
                                <div className="text-center mb-8">
                                    <h2 className="text-slate-400 font-bold uppercase tracking-widest text-xs mb-2">Total Amount</h2>
                                    <div className="text-5xl font-black text-slate-800">{formatCurrency(total)}</div>
                                </div>
                                <div className="grid grid-cols-2 gap-4 mb-6">
                                    <button onClick={()=>handlePay('cash')} className="p-6 border-2 border-slate-100 rounded-3xl hover:border-green-500 hover:bg-green-50 transition-all group flex flex-col items-center gap-3">
                                        <div className="p-3 bg-green-100 text-green-600 rounded-full group-hover:scale-110 transition-transform"><Lucide name="banknote" size={32}/></div>
                                        <span className="font-bold text-slate-700">Cash</span>
                                    </button>
                                    <button onClick={()=>handlePay('qr')} className="p-6 border-2 border-slate-100 rounded-3xl hover:border-blue-500 hover:bg-blue-50 transition-all group flex flex-col items-center gap-3 relative overflow-hidden">
                                        {settings.promptPayQr ? 
                                            <><img src={settings.promptPayQr} className="absolute inset-0 w-full h-full object-cover opacity-30"/><span className="font-bold text-slate-700 z-10">Scan QR</span></> : 
                                            <><div className="p-3 bg-blue-100 text-blue-600 rounded-full"><Lucide name="scan" size={32}/></div><span className="font-bold text-slate-700">PromptPay</span></>
                                        }
                                    </button>
                                </div>
                                <button onClick={()=>setShowPay(false)} className="w-full py-4 bg-slate-100 text-slate-600 font-bold rounded-2xl hover:bg-slate-200">Cancel</button>
                            </div>
                        </div>
                    )}

                    {lastOrder && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm animate-in fade-in">
                            <div className="bg-white w-full max-w-[380px] max-h-[90vh] flex flex-col rounded-xl shadow-2xl overflow-hidden relative">
                                
                                {/* Close Button */}
                                <button 
                                    onClick={() => setLastOrder(null)} 
                                    className="absolute top-2 right-2 p-2 bg-slate-100 hover:bg-red-100 text-slate-500 hover:text-red-500 rounded-full z-10 print:hidden"
                                >
                                    <Lucide name="x" size={20}/>
                                </button>

                                {/* Scrollable Receipt Content */}
                                <div className="overflow-y-auto p-6 flex-1" id="receipt-content">
                                    <div className="text-center mb-6">
                                        {settings.logo ? 
                                            <img src={settings.logo} className="h-16 mx-auto mb-2 object-contain" /> : 
                                            <div className="w-12 h-12 bg-slate-900 rounded-full mx-auto mb-2 flex items-center justify-center text-white font-bold text-xl">BN</div>
                                        }
                                        <h2 className="text-xl font-bold text-slate-900">{settings.shopName}</h2>
                                        <p className="text-xs text-slate-500 mt-1">{settings.address || 'No Address'}</p>
                                        <p className="text-xs text-slate-500">Tel: {settings.phone || '-'}</p>
                                    </div>

                                    <div className="border-b-2 border-dashed border-slate-300 my-4"></div>

                                    <div className="flex justify-between text-xs text-slate-500 mb-2">
                                        <span>Date: {lastOrder.date.split(',')[0]}</span>
                                        <span>Time: {lastOrder.date.split(',')[1]}</span>
                                    </div>
                                    <div className="flex justify-between text-xs text-slate-500 mb-4">
                                        <span>Order: {lastOrder.id}</span>
                                        <span>Staff: {currentUser?.role || 'Admin'}</span>
                                    </div>

                                    <div className="flex flex-col gap-2 mb-4">
                                        {lastOrder.items.map((item, idx) => (
                                            <div key={idx} className="flex justify-between text-sm">
                                                <div className="flex-1">
                                                    <span className="text-slate-800 font-medium">{item.name}</span>
                                                    <div className="text-xs text-slate-500">x{item.qty} @ {formatCurrency(item.price)}</div>
                                                </div>
                                                <span className="font-bold text-slate-900">{formatCurrency(item.price * item.qty)}</span>
                                            </div>
                                        ))}
                                    </div>

                                    <div className="border-b-2 border-dashed border-slate-300 my-4"></div>

                                    <div className="space-y-1">
                                        <div className="flex justify-between text-sm">
                                            <span className="text-slate-600">Subtotal</span>
                                            <span className="font-bold">{formatCurrency(lastOrder.subtotal)}</span>
                                        </div>
                                        {lastOrder.discount > 0 && (
                                            <div className="flex justify-between text-sm text-green-600">
                                                <span>Discount</span>
                                                <span>-{formatCurrency(lastOrder.discount)}</span>
                                            </div>
                                        )}
                                        <div className="flex justify-between text-xl font-black text-slate-900 mt-2">
                                            <span>TOTAL</span>
                                            <span>{formatCurrency(lastOrder.total)}</span>
                                        </div>
                                        <div className="flex justify-between text-xs text-slate-500 mt-1 uppercase">
                                            <span>Payment Type</span>
                                            <span>{lastOrder.method}</span>
                                        </div>
                                    </div>

                                    <div className="mt-8 text-center">
                                        <p className="text-slate-900 font-bold">Thank you!</p>
                                        <p className="text-xs text-slate-400 mt-1">Powered by BN POS</p>
                                        <div className="mt-4 h-12 bg-slate-100 rounded flex items-center justify-center text-xs text-slate-400 tracking-widest font-mono">
                                            ||| ||||| || |||| |||
                                        </div>
                                    </div>
                                </div>

                                {/* Footer Actions */}
                                <div className="p-4 bg-slate-50 border-t border-slate-200 flex gap-3 print:hidden">
                                    <button 
                                        onClick={() => window.print()} 
                                        className="flex-1 py-3 bg-white border border-slate-300 text-slate-700 font-bold rounded-xl shadow-sm hover:bg-slate-100 flex items-center justify-center gap-2"
                                    >
                                        <Lucide name="printer" size={18}/> ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
                                    </button>
                                    <button 
                                        onClick={() => setLastOrder(null)} 
                                        className="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-md hover:bg-blue-700 flex items-center justify-center gap-2"
                                    >
                                        <Lucide name="plus" size={18}/> ‡∏Ç‡∏≤‡∏¢‡∏ï‡πà‡∏≠
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
